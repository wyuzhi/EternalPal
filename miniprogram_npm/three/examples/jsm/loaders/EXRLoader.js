import{DataTextureLoader,DataUtils,FloatType,HalfFloatType,LinearFilter,LinearSRGBColorSpace,RedFormat,RGFormat,RGBAFormat}from"three";import*as fflate from"../libs/fflate.module.js";class EXRLoader extends DataTextureLoader{constructor(e){super(e),this.type=HalfFloatType,this.outputFormat=RGBAFormat}parse(e){const t=65536,n=14,o=65537,r=16384,l=Math.pow(2.7182818,2.2);const a={l:0,c:0,lc:0};function i(e,t,n,o,r){for(;n<e;)t=t<<8|G(o,r),n+=8;n-=e,a.l=t>>n&(1<<e)-1,a.c=t,a.lc=n}const s=new Array(59);function c(e,t,n,r,l,c){const u=t;let f=0,h=0;for(;r<=l;r++){if(u.value-t.value>n)return!1;i(6,f,h,e,u);const o=a.l;if(f=a.c,h=a.lc,c[r]=o,63==o){if(u.value-t.value>n)throw new Error("Something wrong with hufUnpackEncTable");i(8,f,h,e,u);let o=a.l+6;if(f=a.c,h=a.lc,r+o>l+1)throw new Error("Something wrong with hufUnpackEncTable");for(;o--;)c[r++]=0;r--}else if(o>=59){let e=o-59+2;if(r+e>l+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)c[r++]=0;r--}}!function(e){for(let e=0;e<=58;++e)s[e]=0;for(let t=0;t<o;++t)s[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const n=t+s[e]>>1;s[e]=t,t=n}for(let t=0;t<o;++t){const n=e[t];n>0&&(e[t]=n|s[n]++<<6)}}(c)}function u(e){return 63&e}function f(e){return e>>6}const h={c:0,lc:0};function p(e,t,n,o){e=e<<8|G(n,o),t+=8,h.c=e,h.lc=t}const d={c:0,lc:0};function w(e,t,n,o,r,l,a,i,s){if(e==t){o<8&&(p(n,o,r,l),n=h.c,o=h.lc);let e=n>>(o-=8);if(e=new Uint8Array([e])[0],i.value+e>s)return!1;const t=a[i.value-1];for(;e-- >0;)a[i.value++]=t}else{if(!(i.value<s))return!1;a[i.value++]=e}d.c=n,d.lc=o}function y(e){return 65535&e}function m(e){const t=y(e);return t>32767?t-65536:t}const g={a:0,b:0};function v(e,t){const n=m(e),o=m(t),r=n+(1&o)+(o>>1),l=r,a=r-o;g.a=l,g.b=a}function S(e,t){const n=y(e),o=y(t),r=n-(o>>1)&65535,l=o+r-32768&65535;g.a=l,g.b=r}function b(e,t,n,o,r,l,a){const i=a<16384,s=n>r?r:n;let c,u,f=1;for(;f<=s;)f<<=1;for(f>>=1,c=f,f>>=1;f>=1;){u=0;const a=u+l*(r-c),s=l*f,h=l*c,p=o*f,d=o*c;let w,y,m,b;for(;u<=a;u+=h){let r=u;const l=u+o*(n-c);for(;r<=l;r+=d){const n=r+p,o=r+s,l=o+p;i?(v(e[r+t],e[o+t]),w=g.a,m=g.b,v(e[n+t],e[l+t]),y=g.a,b=g.b,v(w,y),e[r+t]=g.a,e[n+t]=g.b,v(m,b),e[o+t]=g.a,e[l+t]=g.b):(S(e[r+t],e[o+t]),w=g.a,m=g.b,S(e[n+t],e[l+t]),y=g.a,b=g.b,S(w,y),e[r+t]=g.a,e[n+t]=g.b,S(m,b),e[o+t]=g.a,e[l+t]=g.b)}if(n&f){const n=r+s;i?v(e[r+t],e[n+t]):S(e[r+t],e[n+t]),w=g.a,e[n+t]=g.b,e[r+t]=w}}if(r&f){let r=u;const l=u+o*(n-c);for(;r<=l;r+=d){const n=r+p;i?v(e[r+t],e[n+t]):S(e[r+t],e[n+t]),w=g.a,e[n+t]=g.b,e[r+t]=w}}c=f,f>>=1}return u}function E(e,t,l,a,i,s){const y=l.value,m=T(t,l),g=T(t,l);l.value+=4;const v=T(t,l);if(l.value+=4,m<0||m>=o||g<0||g>=o)throw new Error("Something wrong with HUF_ENCSIZE");const S=new Array(o),b=new Array(r);!function(e){for(let t=0;t<r;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(b);if(c(e,l,a-(l.value-y),m,g,S),v>8*(a-(l.value-y)))throw new Error("Something wrong with hufUncompress");!function(e,t,o,r){for(;t<=o;t++){const o=f(e[t]),l=u(e[t]);if(o>>l)throw new Error("Invalid table entry");if(l>n){const e=r[o>>l-n];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let n=0;n<e.lit-1;++n)e.p[n]=t[n]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(l){let e=0;for(let a=1<<n-l;a>0;a--){const a=r[(o<<n-l)+e];if(a.len||a.p)throw new Error("Invalid table entry");a.len=l,a.lit=t,e++}}}}(S,m,g,b),function(e,t,o,r,l,a,i,s,c){let y=0,m=0;const g=i,v=Math.trunc(r.value+(l+7)/8);for(;r.value<v;)for(p(y,m,o,r),y=h.c,m=h.lc;m>=n;){const l=t[y>>m-n&16383];if(l.len)m-=l.len,w(l.lit,a,y,m,o,r,s,c,g),y=d.c,m=d.lc;else{if(!l.p)throw new Error("hufDecode issues");let t;for(t=0;t<l.lit;t++){const n=u(e[l.p[t]]);for(;m<n&&r.value<v;)p(y,m,o,r),y=h.c,m=h.lc;if(m>=n&&f(e[l.p[t]])==(y>>m-n&(1<<n)-1)){m-=n,w(l.p[t],a,y,m,o,r,s,c,g),y=d.c,m=d.lc;break}}if(t==l.lit)throw new Error("hufDecode issues")}}const S=8-l&7;for(y>>=S,m-=S;m>0;){const e=t[y<<n-m&16383];if(!e.len)throw new Error("hufDecode issues");m-=e.len,w(e.lit,a,y,m,o,r,s,c,g),y=d.c,m=d.lc}}(S,b,e,l,v,g,s,i,{value:0})}function A(e){for(let t=1;t<e.length;t++){const n=e[t-1]+e[t]-128;e[t]=n}}function C(e,t){let n=0,o=Math.floor((e.length+1)/2),r=0;const l=e.length-1;for(;!(r>l||(t[r++]=e[n++],r>l));)t[r++]=e[o++]}function R(e){let t=e.byteLength;const n=new Array;let o=0;const r=new DataView(e);for(;t>0;){const e=r.getInt8(o++);if(e<0){const l=-e;t-=l+1;for(let e=0;e<l;e++)n.push(r.getUint8(o++))}else{const l=e;t-=2;const a=r.getUint8(o++);for(let e=0;e<l+1;e++)n.push(a)}}return n}function M(e,t,n,o,r,l){const a=new DataView(l.buffer),i=n[e],s=i.width,c=i.height,u=Math.ceil(s/8),f=Math.ceil(c/8),h=Math.floor(s/8),p=s-8*(u-1),d=c-8*(f-1),w={value:0};let y=0;const m=new Float32Array(64),g=new Uint16Array(64),v=new Uint16Array(64*u);for(let n=0;n<f;++n){let l=8;n==f-1&&(l=d);for(let e=0;e<u;++e)g.fill(0),g[0]=r[y++],U(w,o,g),O(g,m),k(m),x(m,v,64*e);for(let o=8*n;o<8*n+l;++o){let n=t[e][o];for(let e=0;e<h;++e){const t=64*e+8*(7&o);for(let e=0;e<8;++e)a.setUint16(n+2*e*i.type,v[t+e],!0);n+=16*i.type}if(u!=h){const e=64*h+8*(7&o);for(let t=0;t<p;++t)a.setUint16(n+2*t*i.type,v[e+t],!0)}}}i.decoded=!0}function U(e,t,n){let o,r=1;for(;r<64;)o=t[e.value],65280==o?r=64:o>>8==255?r+=255&o:(n[r]=o,r++),e.value++}function O(e,t){t[0]=Z(e[0]),t[1]=Z(e[1]),t[2]=Z(e[5]),t[3]=Z(e[6]),t[4]=Z(e[14]),t[5]=Z(e[15]),t[6]=Z(e[27]),t[7]=Z(e[28]),t[8]=Z(e[2]),t[9]=Z(e[4]),t[10]=Z(e[7]),t[11]=Z(e[13]),t[12]=Z(e[16]),t[13]=Z(e[26]),t[14]=Z(e[29]),t[15]=Z(e[42]),t[16]=Z(e[3]),t[17]=Z(e[8]),t[18]=Z(e[12]),t[19]=Z(e[17]),t[20]=Z(e[25]),t[21]=Z(e[30]),t[22]=Z(e[41]),t[23]=Z(e[43]),t[24]=Z(e[9]),t[25]=Z(e[11]),t[26]=Z(e[18]),t[27]=Z(e[24]),t[28]=Z(e[31]),t[29]=Z(e[40]),t[30]=Z(e[44]),t[31]=Z(e[53]),t[32]=Z(e[10]),t[33]=Z(e[19]),t[34]=Z(e[23]),t[35]=Z(e[32]),t[36]=Z(e[39]),t[37]=Z(e[45]),t[38]=Z(e[52]),t[39]=Z(e[54]),t[40]=Z(e[20]),t[41]=Z(e[22]),t[42]=Z(e[33]),t[43]=Z(e[38]),t[44]=Z(e[46]),t[45]=Z(e[51]),t[46]=Z(e[55]),t[47]=Z(e[60]),t[48]=Z(e[21]),t[49]=Z(e[34]),t[50]=Z(e[37]),t[51]=Z(e[47]),t[52]=Z(e[50]),t[53]=Z(e[56]),t[54]=Z(e[59]),t[55]=Z(e[61]),t[56]=Z(e[35]),t[57]=Z(e[36]),t[58]=Z(e[48]),t[59]=Z(e[49]),t[60]=Z(e[57]),t[61]=Z(e[58]),t[62]=Z(e[62]),t[63]=Z(e[63])}function k(e){const t=.5*Math.cos(.7853975),n=.5*Math.cos(3.14159/16),o=.5*Math.cos(3.14159/8),r=.5*Math.cos(3*3.14159/16),l=.5*Math.cos(.981746875),a=.5*Math.cos(3*3.14159/8),i=.5*Math.cos(1.374445625),s=new Array(4),c=new Array(4),u=new Array(4),f=new Array(4);for(let h=0;h<8;++h){const p=8*h;s[0]=o*e[p+2],s[1]=a*e[p+2],s[2]=o*e[p+6],s[3]=a*e[p+6],c[0]=n*e[p+1]+r*e[p+3]+l*e[p+5]+i*e[p+7],c[1]=r*e[p+1]-i*e[p+3]-n*e[p+5]-l*e[p+7],c[2]=l*e[p+1]-n*e[p+3]+i*e[p+5]+r*e[p+7],c[3]=i*e[p+1]-l*e[p+3]+r*e[p+5]-n*e[p+7],u[0]=t*(e[p+0]+e[p+4]),u[3]=t*(e[p+0]-e[p+4]),u[1]=s[0]+s[3],u[2]=s[1]-s[2],f[0]=u[0]+u[1],f[1]=u[3]+u[2],f[2]=u[3]-u[2],f[3]=u[0]-u[1],e[p+0]=f[0]+c[0],e[p+1]=f[1]+c[1],e[p+2]=f[2]+c[2],e[p+3]=f[3]+c[3],e[p+4]=f[3]-c[3],e[p+5]=f[2]-c[2],e[p+6]=f[1]-c[1],e[p+7]=f[0]-c[0]}for(let h=0;h<8;++h)s[0]=o*e[16+h],s[1]=a*e[16+h],s[2]=o*e[48+h],s[3]=a*e[48+h],c[0]=n*e[8+h]+r*e[24+h]+l*e[40+h]+i*e[56+h],c[1]=r*e[8+h]-i*e[24+h]-n*e[40+h]-l*e[56+h],c[2]=l*e[8+h]-n*e[24+h]+i*e[40+h]+r*e[56+h],c[3]=i*e[8+h]-l*e[24+h]+r*e[40+h]-n*e[56+h],u[0]=t*(e[h]+e[32+h]),u[3]=t*(e[h]-e[32+h]),u[1]=s[0]+s[3],u[2]=s[1]-s[2],f[0]=u[0]+u[1],f[1]=u[3]+u[2],f[2]=u[3]-u[2],f[3]=u[0]-u[1],e[0+h]=f[0]+c[0],e[8+h]=f[1]+c[1],e[16+h]=f[2]+c[2],e[24+h]=f[3]+c[3],e[32+h]=f[3]-c[3],e[40+h]=f[2]-c[2],e[48+h]=f[1]-c[1],e[56+h]=f[0]-c[0]}function L(e){for(let t=0;t<64;++t){const n=e[0][t],o=e[1][t],r=e[2][t];e[0][t]=n+1.5747*r,e[1][t]=n-.1873*o-.4682*r,e[2][t]=n+1.8556*o}}function x(e,t,n){for(let o=0;o<64;++o)t[n+o]=DataUtils.toHalfFloat(F(e[o]))}function F(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(l,Math.abs(e)-1)}function I(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function P(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(R(t)),o=new Uint8Array(n.length);return A(n),C(n,o),new DataView(o.buffer)}function N(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),n=fflate.unzlibSync(t),o=new Uint8Array(n.length);return A(n),C(n,o),new DataView(o.buffer)}function z(e){const n=e.viewer,o={value:e.offset.value},r=new Uint16Array(e.columns*e.lines*(e.inputChannels.length*e.type)),l=new Uint8Array(8192);let a=0;const i=new Array(e.inputChannels.length);for(let t=0,n=e.inputChannels.length;t<n;t++)i[t]={},i[t].start=a,i[t].end=i[t].start,i[t].nx=e.columns,i[t].ny=e.lines,i[t].size=e.type,a+=i[t].nx*i[t].ny*i[t].size;const s=j(n,o),c=j(n,o);if(c>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(s<=c)for(let e=0;e<c-s+1;e++)l[e+s]=V(n,o);const u=new Uint16Array(t),f=function(e,n){let o=0;for(let r=0;r<t;++r)(0==r||e[r>>3]&1<<(7&r))&&(n[o++]=r);const r=o-1;for(;o<t;)n[o++]=0;return r}(l,u),h=T(n,o);E(e.array,n,o,h,r,a);for(let t=0;t<e.inputChannels.length;++t){const e=i[t];for(let n=0;n<i[t].size;++n)b(r,e.start+n,e.nx,e.size,e.ny,e.nx*e.size,f)}!function(e,t,n){for(let o=0;o<n;++o)t[o]=e[t[o]]}(u,r,a);let p=0;const d=new Uint8Array(r.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.inputChannels.length;t++){const e=i[t],n=e.nx*e.size,o=new Uint8Array(r.buffer,2*e.end,2*n);d.set(o,p),p+=2*n,e.end+=n}return new DataView(d.buffer)}function _(e){const t=e.array.slice(e.offset.value,e.offset.value+e.size),n=fflate.unzlibSync(t),o=e.inputChannels.length*e.lines*e.columns*e.totalBytes,r=new ArrayBuffer(o),l=new DataView(r);let a=0,i=0;const s=new Array(4);for(let t=0;t<e.lines;t++)for(let t=0;t<e.inputChannels.length;t++){let o=0;switch(e.inputChannels[t].pixelType){case 1:s[0]=a,s[1]=s[0]+e.columns,a=s[1]+e.columns;for(let t=0;t<e.columns;++t){o+=n[s[0]++]<<8|n[s[1]++],l.setUint16(i,o,!0),i+=2}break;case 2:s[0]=a,s[1]=s[0]+e.columns,s[2]=s[1]+e.columns,a=s[2]+e.columns;for(let t=0;t<e.columns;++t){o+=n[s[0]++]<<24|n[s[1]++]<<16|n[s[2]++]<<8,l.setUint32(i,o,!0),i+=4}}}return l}function B(e){const t=e.viewer,n={value:e.offset.value},o=new Uint8Array(e.columns*e.lines*(e.inputChannels.length*e.type*2)),r={version:X(t,n),unknownUncompressedSize:X(t,n),unknownCompressedSize:X(t,n),acCompressedSize:X(t,n),dcCompressedSize:X(t,n),rleCompressedSize:X(t,n),rleUncompressedSize:X(t,n),rleRawSize:X(t,n),totalAcUncompressedCount:X(t,n),totalDcUncompressedCount:X(t,n),acCompression:X(t,n)};if(r.version<2)throw new Error("EXRLoader.parse: "+re.compression+" version "+r.version+" is unsupported");const l=new Array;let a=j(t,n)-2;for(;a>0;){const e=D(t.buffer,n),o=V(t,n),r=o>>2&3,i=new Int8Array([(o>>4)-1])[0],s=V(t,n);l.push({name:e,index:i,type:s,compression:r}),a-=e.length+3}const i=re.channels,s=new Array(e.inputChannels.length);for(let t=0;t<e.inputChannels.length;++t){const n=s[t]={},o=i[t];n.name=o.name,n.compression=0,n.decoded=!1,n.type=o.pixelType,n.pLinear=o.pLinear,n.width=e.columns,n.height=e.lines}const c={idx:new Array(3)};for(let t=0;t<e.inputChannels.length;++t){const e=s[t];for(let n=0;n<l.length;++n){const o=l[n];e.name==o.name&&(e.compression=o.compression,o.index>=0&&(c.idx[o.index]=t),e.offset=t)}}let u,f,h;if(r.acCompressedSize>0)switch(r.acCompression){case 0:u=new Uint16Array(r.totalAcUncompressedCount),E(e.array,t,n,r.acCompressedSize,u,r.totalAcUncompressedCount);break;case 1:const o=e.array.slice(n.value,n.value+r.totalAcUncompressedCount),l=fflate.unzlibSync(o);u=new Uint16Array(l.buffer),n.value+=r.totalAcUncompressedCount}if(r.dcCompressedSize>0){const t={array:e.array,offset:n,size:r.dcCompressedSize};f=new Uint16Array(N(t).buffer),n.value+=r.dcCompressedSize}if(r.rleRawSize>0){const t=e.array.slice(n.value,n.value+r.rleCompressedSize);h=R(fflate.unzlibSync(t).buffer),n.value+=r.rleCompressedSize}let p=0;const d=new Array(s.length);for(let e=0;e<d.length;++e)d[e]=new Array;for(let t=0;t<e.lines;++t)for(let t=0;t<s.length;++t)d[t].push(p),p+=s[t].width*e.type*2;void 0!==c.idx[0]&&s[c.idx[0]]&&function(e,t,n,o,r,l){let a=new DataView(l.buffer);const i=n[e.idx[0]].width,s=n[e.idx[0]].height,c=Math.floor(i/8),u=Math.ceil(i/8),f=Math.ceil(s/8),h=i-8*(u-1),p=s-8*(f-1),d={value:0},w=new Array(3),y=new Array(3),m=new Array(3),g=new Array(3),v=new Array(3);for(let n=0;n<3;++n)v[n]=t[e.idx[n]],w[n]=n<1?0:w[n-1]+u*f,y[n]=new Float32Array(64),m[n]=new Uint16Array(64),g[n]=new Uint16Array(64*u);for(let t=0;t<f;++t){let l=8;t==f-1&&(l=p);let i=8;for(let e=0;e<u;++e){e==u-1&&(i=h);for(let e=0;e<3;++e)m[e].fill(0),m[e][0]=r[w[e]++],U(d,o,m[e]),O(m[e],y[e]),k(y[e]);L(y);for(let t=0;t<3;++t)x(y[t],g[t],64*e)}let s=0;for(let o=0;o<3;++o){const r=n[e.idx[o]].type;for(let e=8*t;e<8*t+l;++e){s=v[o][e];for(let t=0;t<c;++t){const n=64*t+8*(7&e);a.setUint16(s+0*r,g[o][n+0],!0),a.setUint16(s+2*r,g[o][n+1],!0),a.setUint16(s+4*r,g[o][n+2],!0),a.setUint16(s+6*r,g[o][n+3],!0),a.setUint16(s+8*r,g[o][n+4],!0),a.setUint16(s+10*r,g[o][n+5],!0),a.setUint16(s+12*r,g[o][n+6],!0),a.setUint16(s+14*r,g[o][n+7],!0),s+=16*r}}if(c!=u)for(let e=8*t;e<8*t+l;++e){const t=v[o][e]+8*c*2*r,n=64*c+8*(7&e);for(let e=0;e<i;++e)a.setUint16(t+2*e*r,g[o][n+e],!0)}}}const S=new Uint16Array(i);a=new DataView(l.buffer);for(let t=0;t<3;++t){n[e.idx[t]].decoded=!0;const o=n[e.idx[t]].type;if(2==n[t].type)for(let e=0;e<s;++e){const n=v[t][e];for(let e=0;e<i;++e)S[e]=a.getUint16(n+2*e*o,!0);for(let e=0;e<i;++e)a.setFloat32(n+2*e*o,Z(S[e]),!0)}}}(c,d,s,u,f,o);for(let t=0;t<s.length;++t){const n=s[t];if(!n.decoded)switch(n.compression){case 2:let r=0,l=0;for(let a=0;a<e.lines;++a){let e=d[t][r];for(let t=0;t<n.width;++t){for(let t=0;t<2*n.type;++t)o[e++]=h[l+t*n.width*n.height];l++}r++}break;case 1:M(t,d,s,u,f,o);break;default:throw new Error("EXRLoader.parse: unsupported channel compression")}}return new DataView(o.buffer)}function D(e,t){const n=new Uint8Array(e);let o=0;for(;0!=n[t.value+o];)o+=1;const r=(new TextDecoder).decode(n.slice(t.value,t.value+o));return t.value=t.value+o+1,r}function H(e,t){const n=e.getInt32(t.value,!0);return t.value=t.value+4,n}function T(e,t){const n=e.getUint32(t.value,!0);return t.value=t.value+4,n}function G(e,t){const n=e[t.value];return t.value=t.value+1,n}function V(e,t){const n=e.getUint8(t.value);return t.value=t.value+1,n}const X=function(e,t){let n;return n="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,n};function W(e,t){const n=e.getFloat32(t.value,!0);return t.value+=4,n}function Y(e,t){return DataUtils.toHalfFloat(W(e,t))}function Z(e){const t=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(t?31===t?n?NaN:1/0:Math.pow(2,t-15)*(1+n/1024):n/1024*6103515625e-14)}function j(e,t){const n=e.getUint16(t.value,!0);return t.value+=2,n}function $(e,t){return Z(j(e,t))}function q(e,t,n,o,r){return"string"===o||"stringvector"===o||"iccProfile"===o?function(e,t,n){const o=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+n));return t.value=t.value+n,o}(t,n,r):"chlist"===o?function(e,t,n,o){const r=n.value,l=[];for(;n.value<r+o-1;){const o=D(t,n),r=H(e,n),a=V(e,n);n.value+=3;const i=H(e,n),s=H(e,n);l.push({name:o,pixelType:r,pLinear:a,xSampling:i,ySampling:s})}return n.value+=1,l}(e,t,n,r):"chromaticities"===o?function(e,t){return{redX:W(e,t),redY:W(e,t),greenX:W(e,t),greenY:W(e,t),blueX:W(e,t),blueY:W(e,t),whiteX:W(e,t),whiteY:W(e,t)}}(e,n):"compression"===o?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][V(e,t)]}(e,n):"box2i"===o?function(e,t){return{xMin:H(e,t),yMin:H(e,t),xMax:H(e,t),yMax:H(e,t)}}(e,n):"envmap"===o?function(e,t){return["ENVMAP_LATLONG","ENVMAP_CUBE"][V(e,t)]}(e,n):"tiledesc"===o?function(e,t){const n=T(e,t),o=T(e,t),r=V(e,t);return{xSize:n,ySize:o,levelMode:["ONE_LEVEL","MIPMAP_LEVELS","RIPMAP_LEVELS"][15&r],roundingMode:["ROUND_DOWN","ROUND_UP"][r>>4]}}(e,n):"lineOrder"===o?function(e,t){return["INCREASING_Y","DECREASING_Y","RANDOM_Y"][V(e,t)]}(e,n):"float"===o?W(e,n):"v2f"===o?function(e,t){return[W(e,t),W(e,t)]}(e,n):"v3f"===o?function(e,t){return[W(e,t),W(e,t),W(e,t)]}(e,n):"int"===o?H(e,n):"rational"===o?function(e,t){return[H(e,t),T(e,t)]}(e,n):"timecode"===o?function(e,t){return[T(e,t),T(e,t)]}(e,n):"preview"===o?(n.value+=r,"skipped"):void(n.value+=r)}function J(e,t,n){let o=0;switch(e.levelMode){case"ONE_LEVEL":o=1;break;case"MIPMAP_LEVELS":o=function(e,t){const n=Math.log2(e);return"ROUND_DOWN"==t?Math.floor(n):Math.ceil(n)}(Math.max(t,n),e.roundingMode)+1;break;case"RIPMAP_LEVELS":throw new Error("THREE.EXRLoader: RIPMAP_LEVELS tiles currently unsupported.")}return o}function K(e,t,n,o){const r=new Array(e);for(let l=0;l<e;l++){const e=1<<l;let a=t/e|0;"ROUND_UP"==o&&a*e<t&&(a+=1);const i=Math.max(a,1);r[l]=(i+n-1)/n|0}return r}function Q(){const e=this,t=e.offset,n={value:0};for(let o=0;o<e.tileCount;o++){const o=H(e.viewer,t),r=H(e.viewer,t);t.value+=8,e.size=T(e.viewer,t);const l=o*e.blockWidth,a=r*e.blockHeight;e.columns=l+e.blockWidth>e.width?e.width-l:e.blockWidth,e.lines=a+e.blockHeight>e.height?e.height-a:e.blockHeight;const i=e.columns*e.totalBytes,s=e.size<e.lines*i?e.uncompress(e):I(e);t.value+=e.size;for(let t=0;t<e.lines;t++){const o=t*e.columns*e.totalBytes;for(let r=0;r<e.inputChannels.length;r++){const i=re.channels[r].name,c=e.channelByteOffsets[i]*e.columns,u=e.decodeChannels[i];if(void 0===u)continue;n.value=o+c;const f=(e.height-(1+a+t))*e.outLineWidth;for(let t=0;t<e.columns;t++){const o=f+(t+l)*e.outputChannels+u;e.byteArray[o]=e.getter(s,n)}}}}}function ee(){const e=this,t=e.offset,n={value:0};for(let o=0;o<e.height/e.blockHeight;o++){const r=H(e.viewer,t)-re.dataWindow.yMin;e.size=T(e.viewer,t),e.lines=r+e.blockHeight>e.height?e.height-r:e.blockHeight;const l=e.columns*e.totalBytes,a=e.size<e.lines*l?e.uncompress(e):I(e);t.value+=e.size;for(let t=0;t<e.blockHeight;t++){const r=o*e.blockHeight,i=t+e.scanOrder(r);if(i>=e.height)continue;const s=t*l,c=(e.height-1-i)*e.outLineWidth;for(let t=0;t<e.inputChannels.length;t++){const o=re.channels[t].name,r=e.channelByteOffsets[o]*e.columns,l=e.decodeChannels[o];if(void 0!==l){n.value=s+r;for(let t=0;t<e.columns;t++){const o=c+t*e.outputChannels+l;e.byteArray[o]=e.getter(a,n)}}}}}}const te={value:0},ne=new DataView(e),oe=new Uint8Array(e),re=function(e,t,n){const o={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");o.version=e.getUint8(4);const r=e.getUint8(5);o.spec={singleTile:!!(2&r),longName:!!(4&r),deepFormat:!!(8&r),multiPart:!!(16&r)},n.value=8;let l=!0;for(;l;){const r=D(t,n);if(""===r)l=!1;else{const l=D(t,n),a=q(e,t,n,l,T(e,n));void 0===a?console.warn(`THREE.EXRLoader: Skipped unknown header attribute type '${l}'.`):o[r]=a}}if(0!=(-7&r))throw console.error("THREE.EXRHeader:",o),new Error("THREE.EXRLoader: Provided file is currently unsupported.");return o}(ne,e,te),le=function(e,t,n,o,r,l){const a={size:0,viewer:t,array:n,offset:o,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,inputChannels:e.channels,channelByteOffsets:{},shouldExpand:!1,scanOrder:null,totalBytes:null,columns:null,lines:null,type:null,uncompress:null,getter:null,format:null,colorSpace:LinearSRGBColorSpace};switch(e.compression){case"NO_COMPRESSION":a.blockHeight=1,a.uncompress=I;break;case"RLE_COMPRESSION":a.blockHeight=1,a.uncompress=P;break;case"ZIPS_COMPRESSION":a.blockHeight=1,a.uncompress=N;break;case"ZIP_COMPRESSION":a.blockHeight=16,a.uncompress=N;break;case"PIZ_COMPRESSION":a.blockHeight=32,a.uncompress=z;break;case"PXR24_COMPRESSION":a.blockHeight=16,a.uncompress=_;break;case"DWAA_COMPRESSION":a.blockHeight=32,a.uncompress=B;break;case"DWAB_COMPRESSION":a.blockHeight=256,a.uncompress=B;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}const i={};for(const t of e.channels)switch(t.name){case"Y":case"R":case"G":case"B":case"A":i[t.name]=!0,a.type=t.pixelType}let s=!1,c=!1;if(i.R&&i.G&&i.B)a.outputChannels=4;else{if(!i.Y)throw new Error("EXRLoader.parse: file contains unsupported data channels.");a.outputChannels=1}switch(a.outputChannels){case 4:l==RGBAFormat?(s=!i.A,a.format=RGBAFormat,a.colorSpace=LinearSRGBColorSpace,a.outputChannels=4,a.decodeChannels={R:0,G:1,B:2,A:3}):l==RGFormat?(a.format=RGFormat,a.colorSpace=LinearSRGBColorSpace,a.outputChannels=2,a.decodeChannels={R:0,G:1}):l==RedFormat?(a.format=RedFormat,a.colorSpace=LinearSRGBColorSpace,a.outputChannels=1,a.decodeChannels={R:0}):c=!0;break;case 1:l==RGBAFormat?(s=!0,a.format=RGBAFormat,a.colorSpace=LinearSRGBColorSpace,a.outputChannels=4,a.shouldExpand=!0,a.decodeChannels={Y:0}):l==RGFormat?(a.format=RGFormat,a.colorSpace=LinearSRGBColorSpace,a.outputChannels=2,a.shouldExpand=!0,a.decodeChannels={Y:0}):l==RedFormat?(a.format=RedFormat,a.colorSpace=LinearSRGBColorSpace,a.outputChannels=1,a.decodeChannels={Y:0}):c=!0;break;default:c=!0}if(c)throw new Error("EXRLoader.parse: invalid output format for specified file.");if(1==a.type)switch(r){case FloatType:a.getter=$;break;case HalfFloatType:a.getter=j}else{if(2!=a.type)throw new Error("EXRLoader.parse: unsupported pixelType "+a.type+" for "+e.compression+".");switch(r){case FloatType:a.getter=W;break;case HalfFloatType:a.getter=Y}}a.columns=a.width;const u=a.width*a.height*a.outputChannels;switch(r){case FloatType:a.byteArray=new Float32Array(u),s&&a.byteArray.fill(1,0,u);break;case HalfFloatType:a.byteArray=new Uint16Array(u),s&&a.byteArray.fill(15360,0,u);break;default:console.error("THREE.EXRLoader: unsupported type: ",r)}let f=0;for(const t of e.channels)void 0!==a.decodeChannels[t.name]&&(a.channelByteOffsets[t.name]=f),f+=2*t.pixelType;if(a.totalBytes=f,a.outLineWidth=a.width*a.outputChannels,"INCREASING_Y"===e.lineOrder?a.scanOrder=e=>e:a.scanOrder=e=>a.height-1-e,e.spec.singleTile){a.blockHeight=e.tiles.ySize,a.blockWidth=e.tiles.xSize;const n=J(e.tiles,a.width,a.height),r=K(n,a.width,e.tiles.xSize,e.tiles.roundingMode),l=K(n,a.height,e.tiles.ySize,e.tiles.roundingMode);a.tileCount=r[0]*l[0];for(let e=0;e<n;e++)for(let n=0;n<l[e];n++)for(let n=0;n<r[e];n++)X(t,o);a.decode=Q.bind(a)}else{a.blockWidth=a.width;const e=Math.ceil(a.height/a.blockHeight);for(let n=0;n<e;n++)X(t,o);a.decode=ee.bind(a)}return a}(re,ne,oe,te,this.type,this.outputFormat);if(le.decode(),le.shouldExpand){const e=le.byteArray;if(this.outputFormat==RGBAFormat)for(let t=0;t<e.length;t+=4)e[t+2]=e[t+1]=e[t];else if(this.outputFormat==RGFormat)for(let t=0;t<e.length;t+=2)e[t+1]=e[t]}return{header:re,width:le.width,height:le.height,data:le.byteArray,format:le.format,colorSpace:le.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}setOutputFormat(e){return this.outputFormat=e,this}load(e,t,n,o){return super.load(e,(function(e,n){e.colorSpace=n.colorSpace,e.minFilter=LinearFilter,e.magFilter=LinearFilter,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,n)}),n,o)}}export{EXRLoader};
//# sourceMappingURL=EXRLoader.js.map