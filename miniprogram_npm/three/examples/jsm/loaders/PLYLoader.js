import{BufferGeometry,FileLoader,Float32BufferAttribute,Loader,Color,SRGBColorSpace}from"three";const _color=new Color;class PLYLoader extends Loader{constructor(e){super(e),this.propertyNameMapping={},this.customPropertyMapping={}}load(e,t,r,n){const o=this,s=new FileLoader(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,(function(r){try{t(o.parse(r))}catch(t){n?n(t):console.error(t),o.manager.itemError(e)}}),r,n)}setPropertyNameMapping(e){this.propertyNameMapping=e}setCustomPropertyNameMapping(e){this.customPropertyMapping=e}parse(e){function t(e,t=0){let r="";const n=/^ply([\s\S]*)end_header(\r\n|\r|\n)/.exec(e);null!==n&&(r=n[1]);const o={comments:[],elements:[],headerLength:t,objInfo:""},s=r.split(/\r\n|\r|\n/);let a;function c(e,t){const r={type:e[0]};return"list"===r.type?(r.name=e[3],r.countType=e[1],r.itemType=e[2]):r.name=e[1],r.name in t&&(r.name=t[r.name]),r}for(let e=0;e<s.length;e++){let t=s[e];if(t=t.trim(),""===t)continue;const r=t.split(/\s+/),n=r.shift();switch(t=r.join(" "),n){case"format":o.format=r[0],o.version=r[1];break;case"comment":o.comments.push(t);break;case"element":void 0!==a&&o.elements.push(a),a={},a.name=r[0],a.count=parseInt(r[1]),a.properties=[];break;case"property":a.properties.push(c(r,f.propertyNameMapping));break;case"obj_info":o.objInfo=t;break;default:console.log("unhandled",n,r)}}return void 0!==a&&o.elements.push(a),o}function r(e,t){switch(t){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function n(e,t){const n={};for(let o=0;o<e.length;o++){if(t.empty())return null;if("list"===e[o].type){const s=[],a=r(t.next(),e[o].countType);for(let n=0;n<a;n++){if(t.empty())return null;s.push(r(t.next(),e[o].itemType))}n[e[o].name]=s}else n[e[o].name]=r(t.next(),e[o].type)}return n}function o(){const e={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[],faceVertexColors:[]};for(const t of Object.keys(f.customPropertyMapping))e[t]=[];return e}function s(e){const t=e.map((e=>e.name));function r(e){for(let r=0,n=e.length;r<n;r++){const n=e[r];if(t.includes(n))return n}return null}return{attrX:r(["x","px","posx"])||"x",attrY:r(["y","py","posy"])||"y",attrZ:r(["z","pz","posz"])||"z",attrNX:r(["nx","normalx"]),attrNY:r(["ny","normaly"]),attrNZ:r(["nz","normalz"]),attrS:r(["s","u","texture_u","tx"]),attrT:r(["t","v","texture_v","ty"]),attrR:r(["red","diffuse_red","r","diffuse_r"]),attrG:r(["green","diffuse_green","g","diffuse_g"]),attrB:r(["blue","diffuse_blue","b","diffuse_b"])}}function a(e,t){const r=o();let a,i;a=null!==(i=/end_header\s+(\S[\s\S]*\S|\S)\s*$/.exec(e))?i[1].split(/\s+/):[];const u=new ArrayStream(a);e:for(let e=0;e<t.elements.length;e++){const o=t.elements[e],a=s(o.properties);for(let e=0;e<o.count;e++){const e=n(o.properties,u);if(!e)break e;l(r,o.name,e,a)}}return c(r)}function c(e){let t=new BufferGeometry;e.indices.length>0&&t.setIndex(e.indices),t.setAttribute("position",new Float32BufferAttribute(e.vertices,3)),e.normals.length>0&&t.setAttribute("normal",new Float32BufferAttribute(e.normals,3)),e.uvs.length>0&&t.setAttribute("uv",new Float32BufferAttribute(e.uvs,2)),e.colors.length>0&&t.setAttribute("color",new Float32BufferAttribute(e.colors,3)),(e.faceVertexUvs.length>0||e.faceVertexColors.length>0)&&(t=t.toNonIndexed(),e.faceVertexUvs.length>0&&t.setAttribute("uv",new Float32BufferAttribute(e.faceVertexUvs,2)),e.faceVertexColors.length>0&&t.setAttribute("color",new Float32BufferAttribute(e.faceVertexColors,3)));for(const r of Object.keys(f.customPropertyMapping))e[r].length>0&&t.setAttribute(r,new Float32BufferAttribute(e[r],f.customPropertyMapping[r].length));return t.computeBoundingSphere(),t}function l(e,t,r,n){if("vertex"===t){e.vertices.push(r[n.attrX],r[n.attrY],r[n.attrZ]),null!==n.attrNX&&null!==n.attrNY&&null!==n.attrNZ&&e.normals.push(r[n.attrNX],r[n.attrNY],r[n.attrNZ]),null!==n.attrS&&null!==n.attrT&&e.uvs.push(r[n.attrS],r[n.attrT]),null!==n.attrR&&null!==n.attrG&&null!==n.attrB&&(_color.setRGB(r[n.attrR]/255,r[n.attrG]/255,r[n.attrB]/255,SRGBColorSpace),e.colors.push(_color.r,_color.g,_color.b));for(const t of Object.keys(f.customPropertyMapping))for(const n of f.customPropertyMapping[t])e[t].push(r[n])}else if("face"===t){const t=r.vertex_indices||r.vertex_index,o=r.texcoord;3===t.length?(e.indices.push(t[0],t[1],t[2]),o&&6===o.length&&(e.faceVertexUvs.push(o[0],o[1]),e.faceVertexUvs.push(o[2],o[3]),e.faceVertexUvs.push(o[4],o[5]))):4===t.length&&(e.indices.push(t[0],t[1],t[3]),e.indices.push(t[1],t[2],t[3])),null!==n.attrR&&null!==n.attrG&&null!==n.attrB&&(_color.setRGB(r[n.attrR]/255,r[n.attrG]/255,r[n.attrB]/255,SRGBColorSpace),e.faceVertexColors.push(_color.r,_color.g,_color.b),e.faceVertexColors.push(_color.r,_color.g,_color.b),e.faceVertexColors.push(_color.r,_color.g,_color.b))}}function i(e,t){const r={};let n=0;for(let o=0;o<t.length;o++){const s=t[o],a=s.valueReader;if("list"===s.type){const t=[],o=s.countReader.read(e+n);n+=s.countReader.size;for(let r=0;r<o;r++)t.push(a.read(e+n)),n+=a.size;r[s.name]=t}else r[s.name]=a.read(e+n),n+=a.size}return[r,n]}function u(e,t,r){function n(e,t,r){switch(t){case"int8":case"char":return{read:t=>e.getInt8(t),size:1};case"uint8":case"uchar":return{read:t=>e.getUint8(t),size:1};case"int16":case"short":return{read:t=>e.getInt16(t,r),size:2};case"uint16":case"ushort":return{read:t=>e.getUint16(t,r),size:2};case"int32":case"int":return{read:t=>e.getInt32(t,r),size:4};case"uint32":case"uint":return{read:t=>e.getUint32(t,r),size:4};case"float32":case"float":return{read:t=>e.getFloat32(t,r),size:4};case"float64":case"double":return{read:t=>e.getFloat64(t,r),size:8}}}for(let o=0,s=e.length;o<s;o++){const s=e[o];"list"===s.type?(s.countReader=n(t,s.countType,r),s.valueReader=n(t,s.itemType,r)):s.valueReader=n(t,s.type,r)}}let p;const f=this;if(e instanceof ArrayBuffer){const r=new Uint8Array(e),{headerText:n,headerLength:f}=function(e){let t=0,r=!0,n="";const o=[],s=(new TextDecoder).decode(e.subarray(0,5)),a=/^ply\r\n/.test(s);do{const s=String.fromCharCode(e[t++]);"\n"!==s&&"\r"!==s?n+=s:("end_header"===n&&(r=!1),""!==n&&(o.push(n),n=""))}while(r&&t<e.length);return!0===a&&t++,{headerText:o.join("\r")+"\r",headerLength:t}}(r),h=t(n,f);if("ascii"===h.format){p=a((new TextDecoder).decode(r),h)}else p=function(e,t){const r=o(),n="binary_little_endian"===t.format,a=new DataView(e,t.headerLength);let p,f=0;for(let e=0;e<t.elements.length;e++){const o=t.elements[e],c=o.properties,h=s(c);u(c,a,n);for(let e=0;e<o.count;e++){p=i(f,c),f+=p[1];const e=p[0];l(r,o.name,e,h)}}return c(r)}(e,h)}else p=a(e,t(e));return p}}class ArrayStream{constructor(e){this.arr=e,this.i=0}empty(){return this.i>=this.arr.length}next(){return this.arr[this.i++]}}export{PLYLoader};
//# sourceMappingURL=PLYLoader.js.map