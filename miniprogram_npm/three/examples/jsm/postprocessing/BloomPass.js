import{AdditiveBlending,HalfFloatType,ShaderMaterial,UniformsUtils,Vector2,WebGLRenderTarget}from"three";import{Pass,FullScreenQuad}from"./Pass.js";import{ConvolutionShader}from"../shaders/ConvolutionShader.js";class BloomPass extends Pass{constructor(e=1,t=25,r=4){super(),this.combineUniforms=UniformsUtils.clone(CombineShader.uniforms),this.combineUniforms.strength.value=e,this.materialCombine=new ShaderMaterial({name:CombineShader.name,uniforms:this.combineUniforms,vertexShader:CombineShader.vertexShader,fragmentShader:CombineShader.fragmentShader,blending:AdditiveBlending,transparent:!0});const n=ConvolutionShader;this.convolutionUniforms=UniformsUtils.clone(n.uniforms),this.convolutionUniforms.uImageIncrement.value=BloomPass.blurX,this.convolutionUniforms.cKernel.value=buildKernel(r),this.materialConvolution=new ShaderMaterial({name:n.name,uniforms:this.convolutionUniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,defines:{KERNEL_SIZE_FLOAT:t.toFixed(1),KERNEL_SIZE_INT:t.toFixed(0)}}),this.needsSwap=!1,this._renderTargetX=new WebGLRenderTarget(1,1,{type:HalfFloatType}),this._renderTargetX.texture.name="BloomPass.x",this._renderTargetY=new WebGLRenderTarget(1,1,{type:HalfFloatType}),this._renderTargetY.texture.name="BloomPass.y",this._fsQuad=new FullScreenQuad(null)}render(e,t,r,n,s){s&&e.state.buffers.stencil.setTest(!1),this._fsQuad.material=this.materialConvolution,this.convolutionUniforms.tDiffuse.value=r.texture,this.convolutionUniforms.uImageIncrement.value=BloomPass.blurX,e.setRenderTarget(this._renderTargetX),e.clear(),this._fsQuad.render(e),this.convolutionUniforms.tDiffuse.value=this._renderTargetX.texture,this.convolutionUniforms.uImageIncrement.value=BloomPass.blurY,e.setRenderTarget(this._renderTargetY),e.clear(),this._fsQuad.render(e),this._fsQuad.material=this.materialCombine,this.combineUniforms.tDiffuse.value=this._renderTargetY.texture,s&&e.state.buffers.stencil.setTest(!0),e.setRenderTarget(r),this.clear&&e.clear(),this._fsQuad.render(e)}setSize(e,t){this._renderTargetX.setSize(e,t),this._renderTargetY.setSize(e,t)}dispose(){this._renderTargetX.dispose(),this._renderTargetY.dispose(),this.materialCombine.dispose(),this.materialConvolution.dispose(),this._fsQuad.dispose()}}const CombineShader={name:"CombineShader",uniforms:{tDiffuse:{value:null},strength:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float strength;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = strength * texel;\n\n\t\t}"};function gauss(e,t){return Math.exp(-e*e/(2*t*t))}function buildKernel(e){let t=2*Math.ceil(3*e)+1;t>25&&(t=25);const r=.5*(t-1),n=new Array(t);let s=0;for(let i=0;i<t;++i)n[i]=gauss(i-r,e),s+=n[i];for(let e=0;e<t;++e)n[e]/=s;return n}BloomPass.blurX=new Vector2(.001953125,0),BloomPass.blurY=new Vector2(0,.001953125);export{BloomPass};
//# sourceMappingURL=BloomPass.js.map