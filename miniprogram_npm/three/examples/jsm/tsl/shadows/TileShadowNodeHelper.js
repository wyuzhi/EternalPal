import{Group,NodeMaterial,Mesh,PlaneGeometry,DoubleSide,CameraHelper}from"three/webgpu";import{Fn,vec4,vec3,texture,uv,positionLocal,vec2,float,screenSize}from"three/tsl";class TileShadowNodeHelper extends Group{constructor(e){if(super(),!e)throw new Error("TileShadowNode instance is required for TileShadowNodeHelper.");this.tileShadowNode=e,this.config=e.config,this.tiles=e.tiles,this._debugMeshes=[],this._shadowCamHelpers=[],this.initialized=!1}init(){if(this.tileShadowNode._shadowNodes.length!==this.tiles.length)return void console.error("Cannot initialize TileShadowNodeHelper: Shadow nodes not ready or mismatch count.");const e=this.config.tilesX,t=this.config.tilesY;this.dispose();for(let o=0;o<this.tiles.length;o++){const s=new Mesh(new PlaneGeometry(1,1),new NodeMaterial);s.renderOrder=9999999,s.material.transparent=!0,s.frustumCulled=!1,s.side=DoubleSide,s.material.depthTest=!1,s.material.depthWrite=!1;const i=o%e,a=Math.floor(o/e);if(s.material.vertexNode=Fn((()=>{const o=screenSize.x.div(screenSize.y),s=Math.max(e,t),d=float(.8/s),r=float(.01),l=float(.05),h=float(-1).add(l).add(d.div(2).div(o)).add(float(i).mul(d.div(o).add(r))),n=float(1).sub(l).sub(d.div(2)).sub(float(a).mul(d.add(r))),p=vec2(positionLocal.x.mul(d.div(o)),positionLocal.y.mul(d)),u=vec2(p.x.add(h),p.y.add(n));return vec4(u.x,u.y,0,1)}))(),s.material.outputNode=Fn((()=>{if(!this.tileShadowNode.shadowMap||!this.tileShadowNode.shadowMap.depthTexture)return vec4(1,0,1,1);const e=texture(this.tileShadowNode.shadowMap.depthTexture).sample(uv().flipY()).depth(float(o)).compare(.9),t=float(.5+o%3*.16),s=float(.5+o%2*.25),i=float(.7+o%4*.075);return vec4(vec3(t,s,i).mul(e).saturate().rgb,1)}))(),this.add(s),this._debugMeshes.push(s),this.tileShadowNode._shadowNodes[o]&&this.tileShadowNode._shadowNodes[o].shadow){const e=new CameraHelper(this.tileShadowNode._shadowNodes[o].shadow.camera);e.fog=!1,this.add(e),this._shadowCamHelpers.push(e)}else console.warn(`TileShadowNodeHelper: Could not create CameraHelper for tile index ${o}. Shadow node or camera missing.`),this._shadowCamHelpers.push(null)}this.initialized=!0}update(){!1===this.initialized&&this.init();for(const e of this._shadowCamHelpers)e&&(e.update(),e.updateMatrixWorld(!0))}dispose(){if(this.scene){for(const e of this._debugMeshes)e.geometry.dispose(),e.material.dispose(),this.scene.remove(e);for(const e of this._shadowCamHelpers)e&&this.scene.remove(e)}this._debugMeshes=[],this._shadowCamHelpers=[]}}export{TileShadowNodeHelper};
//# sourceMappingURL=TileShadowNodeHelper.js.map