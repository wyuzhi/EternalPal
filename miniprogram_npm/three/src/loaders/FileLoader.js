import{Cache}from"./Cache.js";import{Loader}from"./Loader.js";const loading={};class HttpError extends Error{constructor(e,t){super(e),this.response=t}}class FileLoader extends Loader{constructor(e){super(e),this.mimeType="",this.responseType="",this._abortController=new AbortController}load(e,t,r,o){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=Cache.get(`file:${e}`);if(void 0!==n)return this.manager.itemStart(e),setTimeout((()=>{t&&t(n),this.manager.itemEnd(e)}),0),n;if(void 0!==loading[e])return void loading[e].push({onLoad:t,onProgress:r,onError:o});loading[e]=[],loading[e].push({onLoad:t,onProgress:r,onError:o});const s=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin",signal:"function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal}),a=this.mimeType,i=this.responseType;fetch(s).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;const r=loading[e],o=t.body.getReader(),n=t.headers.get("X-File-Size")||t.headers.get("Content-Length"),s=n?parseInt(n):0,a=0!==s;let i=0;const l=new ReadableStream({start(e){!function t(){o.read().then((({done:o,value:n})=>{if(o)e.close();else{i+=n.byteLength;const o=new ProgressEvent("progress",{lengthComputable:a,loaded:i,total:s});for(let e=0,t=r.length;e<t;e++){const t=r[e];t.onProgress&&t.onProgress(o)}e.enqueue(n),t()}}),(t=>{e.error(t)}))}()}});return new Response(l)}throw new HttpError(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)})).then((e=>{switch(i){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,a)));case"json":return e.json();default:if(""===a)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(a),r=t&&t[1]?t[1].toLowerCase():void 0,o=new TextDecoder(r);return e.arrayBuffer().then((e=>o.decode(e)))}}})).then((t=>{Cache.add(`file:${e}`,t);const r=loading[e];delete loading[e];for(let e=0,o=r.length;e<o;e++){const o=r[e];o.onLoad&&o.onLoad(t)}})).catch((t=>{const r=loading[e];if(void 0===r)throw this.manager.itemError(e),t;delete loading[e];for(let e=0,o=r.length;e<o;e++){const o=r[e];o.onError&&o.onError(t)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}export{FileLoader};
//# sourceMappingURL=FileLoader.js.map