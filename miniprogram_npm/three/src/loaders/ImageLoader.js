import{Cache}from"./Cache.js";import{Loader}from"./Loader.js";import{createElementNS}from"../utils.js";const _loading=new WeakMap;class ImageLoader extends Loader{constructor(e){super(e)}load(e,t,o,r){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=this,a=Cache.get(`image:${e}`);if(void 0!==a){if(!0===a.complete)n.manager.itemStart(e),setTimeout((function(){t&&t(a),n.manager.itemEnd(e)}),0);else{let e=_loading.get(a);void 0===e&&(e=[],_loading.set(a,e)),e.push({onLoad:t,onError:r})}return a}const i=createElementNS("img");function s(){m(),t&&t(this);const o=_loading.get(this)||[];for(let e=0;e<o.length;e++){const t=o[e];t.onLoad&&t.onLoad(this)}_loading.delete(this),n.manager.itemEnd(e)}function d(t){m(),r&&r(t),Cache.remove(`image:${e}`);const o=_loading.get(this)||[];for(let e=0;e<o.length;e++){const r=o[e];r.onError&&r.onError(t)}_loading.delete(this),n.manager.itemError(e),n.manager.itemEnd(e)}function m(){i.removeEventListener("load",s,!1),i.removeEventListener("error",d,!1)}return i.addEventListener("load",s,!1),i.addEventListener("error",d,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(i.crossOrigin=this.crossOrigin),Cache.add(`image:${e}`,i),n.manager.itemStart(e),i.src=e,i}}export{ImageLoader};
//# sourceMappingURL=ImageLoader.js.map