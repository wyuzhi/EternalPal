import Node from"../core/Node.js";import{normalLocal}from"./Normal.js";import{positionLocal}from"./Position.js";import{nodeProxy,vec3,mat3,mat4,int,ivec2,float,Fn}from"../tsl/TSLBase.js";import{textureLoad}from"./TextureNode.js";import{textureSize}from"./TextureSizeNode.js";import{tangentLocal}from"./Tangent.js";import{instanceIndex,drawIndex}from"../core/IndexNode.js";import{varyingProperty}from"../core/PropertyNode.js";class BatchNode extends Node{static get type(){return"BatchNode"}constructor(t){super("void"),this.batchMesh=t,this.batchingIdNode=null}setup(t){null===this.batchingIdNode&&(null===t.getDrawIndex()?this.batchingIdNode=instanceIndex:this.batchingIdNode=drawIndex);const e=Fn((([t])=>{const e=int(textureSize(textureLoad(this.batchMesh._indirectTexture),0).x),o=int(t).mod(e),r=int(t).div(e);return textureLoad(this.batchMesh._indirectTexture,ivec2(o,r)).x})).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]}),o=e(int(this.batchingIdNode)),r=this.batchMesh._matricesTexture,i=int(textureSize(textureLoad(r),0).x),n=float(o).mul(4).toInt().toVar(),a=n.mod(i),d=n.div(i),s=mat4(textureLoad(r,ivec2(a,d)),textureLoad(r,ivec2(a.add(1),d)),textureLoad(r,ivec2(a.add(2),d)),textureLoad(r,ivec2(a.add(3),d))),c=this.batchMesh._colorsTexture;if(null!==c){const t=Fn((([t])=>{const e=int(textureSize(textureLoad(c),0).x),o=t,r=o.mod(e),i=o.div(e);return textureLoad(c,ivec2(r,i)).rgb})).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]}),e=t(o);varyingProperty("vec3","vBatchColor").assign(e)}const u=mat3(s);positionLocal.assign(s.mul(positionLocal));const m=normalLocal.div(vec3(u[0].dot(u[0]),u[1].dot(u[1]),u[2].dot(u[2]))),x=u.mul(m).xyz;normalLocal.assign(x),t.hasGeometryAttribute("tangent")&&tangentLocal.mulAssign(u)}}export default BatchNode;export const batch=nodeProxy(BatchNode).setParameterLength(1);
//# sourceMappingURL=BatchNode.js.map