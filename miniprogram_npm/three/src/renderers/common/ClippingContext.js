import{Matrix3}from"../../math/Matrix3.js";import{Plane}from"../../math/Plane.js";import{Vector4}from"../../math/Vector4.js";const _plane=new Plane;class ClippingContext{constructor(t=null){this.version=0,this.clipIntersection=null,this.cacheKey="",this.shadowPass=!1,this.viewNormalMatrix=new Matrix3,this.clippingGroupContexts=new WeakMap,this.intersectionPlanes=[],this.unionPlanes=[],this.parentVersion=null,null!==t&&(this.viewNormalMatrix=t.viewNormalMatrix,this.clippingGroupContexts=t.clippingGroupContexts,this.shadowPass=t.shadowPass,this.viewMatrix=t.viewMatrix)}projectPlanes(t,i,n){const e=t.length;for(let s=0;s<e;s++){_plane.copy(t[s]).applyMatrix4(this.viewMatrix,this.viewNormalMatrix);const e=i[n+s],o=_plane.normal;e.x=-o.x,e.y=-o.y,e.z=-o.z,e.w=_plane.constant}}updateGlobal(t,i){this.shadowPass=null!==t.overrideMaterial&&t.overrideMaterial.isShadowPassMaterial,this.viewMatrix=i.matrixWorldInverse,this.viewNormalMatrix.getNormalMatrix(this.viewMatrix)}update(t,i){let n=!1;t.version!==this.parentVersion&&(this.intersectionPlanes=Array.from(t.intersectionPlanes),this.unionPlanes=Array.from(t.unionPlanes),this.parentVersion=t.version),this.clipIntersection!==i.clipIntersection&&(this.clipIntersection=i.clipIntersection,this.clipIntersection?this.unionPlanes.length=t.unionPlanes.length:this.intersectionPlanes.length=t.intersectionPlanes.length);const e=i.clippingPlanes,s=e.length;let o,r;if(this.clipIntersection?(o=this.intersectionPlanes,r=t.intersectionPlanes.length):(o=this.unionPlanes,r=t.unionPlanes.length),o.length!==r+s){o.length=r+s;for(let t=0;t<s;t++)o[r+t]=new Vector4;n=!0}this.projectPlanes(e,o,r),n&&(this.version++,this.cacheKey=`${this.intersectionPlanes.length}:${this.unionPlanes.length}`)}getGroupContext(t){if(this.shadowPass&&!t.clipShadows)return this;let i=this.clippingGroupContexts.get(t);return void 0===i&&(i=new ClippingContext(this),this.clippingGroupContexts.set(t,i)),i.update(this,t),i}get unionClippingCount(){return this.unionPlanes.length}}export default ClippingContext;
//# sourceMappingURL=ClippingContext.js.map