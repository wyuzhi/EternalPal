import{CullFaceNone,CullFaceBack,CullFaceFront,DoubleSide,BackSide,NormalBlending,NoBlending,CustomBlending,AddEquation,AdditiveBlending,SubtractiveBlending,MultiplyBlending,SubtractEquation,ReverseSubtractEquation,ZeroFactor,OneFactor,SrcColorFactor,SrcAlphaFactor,SrcAlphaSaturateFactor,DstColorFactor,DstAlphaFactor,OneMinusSrcColorFactor,OneMinusSrcAlphaFactor,OneMinusDstColorFactor,OneMinusDstAlphaFactor,NeverDepth,AlwaysDepth,LessDepth,LessEqualDepth,EqualDepth,GreaterEqualDepth,GreaterDepth,NotEqualDepth}from"../../../constants.js";import{Vector4}from"../../../math/Vector4.js";let equationToGL,factorToGL;class WebGLState{constructor(t){this.backend=t,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,this.currentLineWidth=null,this.currentClippingPlanes=0,this.currentVAO=null,this.currentIndex=null,this.currentBoundFramebuffers={},this.currentDrawbuffers=new WeakMap,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBufferBases={},this._init()}_init(){const t=this.gl;equationToGL={[AddEquation]:t.FUNC_ADD,[SubtractEquation]:t.FUNC_SUBTRACT,[ReverseSubtractEquation]:t.FUNC_REVERSE_SUBTRACT},factorToGL={[ZeroFactor]:t.ZERO,[OneFactor]:t.ONE,[SrcColorFactor]:t.SRC_COLOR,[SrcAlphaFactor]:t.SRC_ALPHA,[SrcAlphaSaturateFactor]:t.SRC_ALPHA_SATURATE,[DstColorFactor]:t.DST_COLOR,[DstAlphaFactor]:t.DST_ALPHA,[OneMinusSrcColorFactor]:t.ONE_MINUS_SRC_COLOR,[OneMinusSrcAlphaFactor]:t.ONE_MINUS_SRC_ALPHA,[OneMinusDstColorFactor]:t.ONE_MINUS_DST_COLOR,[OneMinusDstAlphaFactor]:t.ONE_MINUS_DST_ALPHA};const e=t.getParameter(t.SCISSOR_BOX),n=t.getParameter(t.VIEWPORT);this.currentScissor=(new Vector4).fromArray(e),this.currentViewport=(new Vector4).fromArray(n),this._tempVec4=new Vector4}enable(t){const{enabled:e}=this;!0!==e[t]&&(this.gl.enable(t),e[t]=!0)}disable(t){const{enabled:e}=this;!1!==e[t]&&(this.gl.disable(t),e[t]=!1)}setFlipSided(t){if(this.currentFlipSided!==t){const{gl:e}=this;t?e.frontFace(e.CW):e.frontFace(e.CCW),this.currentFlipSided=t}}setCullFace(t){const{gl:e}=this;t!==CullFaceNone?(this.enable(e.CULL_FACE),t!==this.currentCullFace&&(t===CullFaceBack?e.cullFace(e.BACK):t===CullFaceFront?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):this.disable(e.CULL_FACE),this.currentCullFace=t}setLineWidth(t){const{currentLineWidth:e,gl:n}=this;t!==e&&(n.lineWidth(t),this.currentLineWidth=t)}setBlending(t,e,n,r,s,i,l,c){const{gl:u}=this;if(t!==NoBlending){if(!1===this.currentBlendingEnabled&&(this.enable(u.BLEND),this.currentBlendingEnabled=!0),t===CustomBlending)s=s||e,i=i||n,l=l||r,e===this.currentBlendEquation&&s===this.currentBlendEquationAlpha||(u.blendEquationSeparate(equationToGL[e],equationToGL[s]),this.currentBlendEquation=e,this.currentBlendEquationAlpha=s),n===this.currentBlendSrc&&r===this.currentBlendDst&&i===this.currentBlendSrcAlpha&&l===this.currentBlendDstAlpha||(u.blendFuncSeparate(factorToGL[n],factorToGL[r],factorToGL[i],factorToGL[l]),this.currentBlendSrc=n,this.currentBlendDst=r,this.currentBlendSrcAlpha=i,this.currentBlendDstAlpha=l),this.currentBlending=t,this.currentPremultipledAlpha=!1;else if(t!==this.currentBlending||c!==this.currentPremultipledAlpha){if(this.currentBlendEquation===AddEquation&&this.currentBlendEquationAlpha===AddEquation||(u.blendEquation(u.FUNC_ADD),this.currentBlendEquation=AddEquation,this.currentBlendEquationAlpha=AddEquation),c)switch(t){case NormalBlending:u.blendFuncSeparate(u.ONE,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);break;case AdditiveBlending:u.blendFunc(u.ONE,u.ONE);break;case SubtractiveBlending:u.blendFuncSeparate(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ZERO,u.ONE);break;case MultiplyBlending:u.blendFuncSeparate(u.DST_COLOR,u.ONE_MINUS_SRC_ALPHA,u.ZERO,u.ONE);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case NormalBlending:u.blendFuncSeparate(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);break;case AdditiveBlending:u.blendFuncSeparate(u.SRC_ALPHA,u.ONE,u.ONE,u.ONE);break;case SubtractiveBlending:console.error("THREE.WebGLState: SubtractiveBlending requires material.premultipliedAlpha = true");break;case MultiplyBlending:console.error("THREE.WebGLState: MultiplyBlending requires material.premultipliedAlpha = true");break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=t,this.currentPremultipledAlpha=c}}else!0===this.currentBlendingEnabled&&(this.disable(u.BLEND),this.currentBlendingEnabled=!1)}setColorMask(t){this.currentColorMask!==t&&(this.gl.colorMask(t,t,t,t),this.currentColorMask=t)}setDepthTest(t){const{gl:e}=this;t?this.enable(e.DEPTH_TEST):this.disable(e.DEPTH_TEST)}setDepthMask(t){this.currentDepthMask!==t&&(this.gl.depthMask(t),this.currentDepthMask=t)}setDepthFunc(t){if(this.currentDepthFunc!==t){const{gl:e}=this;switch(t){case NeverDepth:e.depthFunc(e.NEVER);break;case AlwaysDepth:e.depthFunc(e.ALWAYS);break;case LessDepth:e.depthFunc(e.LESS);break;case LessEqualDepth:e.depthFunc(e.LEQUAL);break;case EqualDepth:e.depthFunc(e.EQUAL);break;case GreaterEqualDepth:e.depthFunc(e.GEQUAL);break;case GreaterDepth:e.depthFunc(e.GREATER);break;case NotEqualDepth:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}this.currentDepthFunc=t}}scissor(t,e,n,r){const s=this._tempVec4.set(t,e,n,r);if(!1===this.currentScissor.equals(s)){const{gl:t}=this;t.scissor(s.x,s.y,s.z,s.w),this.currentScissor.copy(s)}}viewport(t,e,n,r){const s=this._tempVec4.set(t,e,n,r);if(!1===this.currentViewport.equals(s)){const{gl:t}=this;t.viewport(s.x,s.y,s.z,s.w),this.currentViewport.copy(s)}}setScissorTest(t){const e=this.gl;t?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST)}setStencilTest(t){const{gl:e}=this;t?this.enable(e.STENCIL_TEST):this.disable(e.STENCIL_TEST)}setStencilMask(t){this.currentStencilMask!==t&&(this.gl.stencilMask(t),this.currentStencilMask=t)}setStencilFunc(t,e,n){this.currentStencilFunc===t&&this.currentStencilRef===e&&this.currentStencilFuncMask===n||(this.gl.stencilFunc(t,e,n),this.currentStencilFunc=t,this.currentStencilRef=e,this.currentStencilFuncMask=n)}setStencilOp(t,e,n){this.currentStencilFail===t&&this.currentStencilZFail===e&&this.currentStencilZPass===n||(this.gl.stencilOp(t,e,n),this.currentStencilFail=t,this.currentStencilZFail=e,this.currentStencilZPass=n)}setMaterial(t,e,n){const{gl:r}=this;t.side===DoubleSide?this.disable(r.CULL_FACE):this.enable(r.CULL_FACE);let s=t.side===BackSide;e&&(s=!s),this.setFlipSided(s),t.blending===NormalBlending&&!1===t.transparent?this.setBlending(NoBlending):this.setBlending(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha),this.setDepthFunc(t.depthFunc),this.setDepthTest(t.depthTest),this.setDepthMask(t.depthWrite),this.setColorMask(t.colorWrite);const i=t.stencilWrite;if(this.setStencilTest(i),i&&(this.setStencilMask(t.stencilWriteMask),this.setStencilFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),this.setStencilOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),this.setPolygonOffset(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage&&this.backend.renderer.samples>1?this.enable(r.SAMPLE_ALPHA_TO_COVERAGE):this.disable(r.SAMPLE_ALPHA_TO_COVERAGE),n>0&&this.currentClippingPlanes!==n){const t=12288;for(let e=0;e<8;e++)e<n?this.enable(t+e):this.disable(t+e)}}setPolygonOffset(t,e,n){const{gl:r}=this;t?(this.enable(r.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===e&&this.currentPolygonOffsetUnits===n||(r.polygonOffset(e,n),this.currentPolygonOffsetFactor=e,this.currentPolygonOffsetUnits=n)):this.disable(r.POLYGON_OFFSET_FILL)}useProgram(t){return this.currentProgram!==t&&(this.gl.useProgram(t),this.currentProgram=t,!0)}setVertexState(t,e=null){const n=this.gl;return(this.currentVAO!==t||this.currentIndex!==e)&&(n.bindVertexArray(t),null!==e&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e),this.currentVAO=t,this.currentIndex=e,!0)}resetVertexState(){const t=this.gl;t.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.currentVAO=null,this.currentIndex=null}bindFramebuffer(t,e){const{gl:n,currentBoundFramebuffers:r}=this;return r[t]!==e&&(n.bindFramebuffer(t,e),r[t]=e,t===n.DRAW_FRAMEBUFFER&&(r[n.FRAMEBUFFER]=e),t===n.FRAMEBUFFER&&(r[n.DRAW_FRAMEBUFFER]=e),!0)}drawBuffers(t,e){const{gl:n}=this;let r=[],s=!1;if(null!==t.textures){r=this.currentDrawbuffers.get(e),void 0===r&&(r=[],this.currentDrawbuffers.set(e,r));const i=t.textures;if(r.length!==i.length||r[0]!==n.COLOR_ATTACHMENT0){for(let t=0,e=i.length;t<e;t++)r[t]=n.COLOR_ATTACHMENT0+t;r.length=i.length,s=!0}}else r[0]!==n.BACK&&(r[0]=n.BACK,s=!0);s&&n.drawBuffers(r)}activeTexture(t){const{gl:e,currentTextureSlot:n,maxTextures:r}=this;void 0===t&&(t=e.TEXTURE0+r-1),n!==t&&(e.activeTexture(t),this.currentTextureSlot=t)}bindTexture(t,e,n){const{gl:r,currentTextureSlot:s,currentBoundTextures:i,maxTextures:l}=this;void 0===n&&(n=null===s?r.TEXTURE0+l-1:s);let c=i[n];void 0===c&&(c={type:void 0,texture:void 0},i[n]=c),c.type===t&&c.texture===e||(s!==n&&(r.activeTexture(n),this.currentTextureSlot=n),r.bindTexture(t,e),c.type=t,c.texture=e)}bindBufferBase(t,e,n){const{gl:r}=this,s=`${t}-${e}`;return this.currentBoundBufferBases[s]!==n&&(r.bindBufferBase(t,e,n),this.currentBoundBufferBases[s]=n,!0)}unbindTexture(){const{gl:t,currentTextureSlot:e,currentBoundTextures:n}=this,r=n[e];void 0!==r&&void 0!==r.type&&(t.bindTexture(r.type,null),r.type=void 0,r.texture=void 0)}}export default WebGLState;
//# sourceMappingURL=WebGLState.js.map