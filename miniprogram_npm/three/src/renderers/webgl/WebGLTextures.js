import{LinearFilter,LinearMipmapLinearFilter,LinearMipmapNearestFilter,NearestFilter,NearestMipmapLinearFilter,NearestMipmapNearestFilter,RGBAFormat,DepthFormat,DepthStencilFormat,UnsignedIntType,FloatType,MirroredRepeatWrapping,ClampToEdgeWrapping,RepeatWrapping,UnsignedByteType,NoColorSpace,LinearSRGBColorSpace,NeverCompare,AlwaysCompare,LessCompare,LessEqualCompare,EqualCompare,GreaterEqualCompare,GreaterCompare,NotEqualCompare,SRGBTransfer,LinearTransfer,UnsignedShortType,UnsignedInt248Type}from"../../constants.js";import{createElementNS}from"../../utils.js";import{ColorManagement}from"../../math/ColorManagement.js";import{Vector2}from"../../math/Vector2.js";import{getByteLength}from"../../extras/TextureUtils.js";function WebGLTextures(e,t,r,a,i,n,o){const E=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,T="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),_=new Vector2,u=new WeakMap;let l;const f=new WeakMap;let s=!1;try{s="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function R(e,t){return s?new OffscreenCanvas(e,t):createElementNS("canvas")}function d(e,t,r){let a=1;const i=Y(e);if((i.width>r||i.height>r)&&(a=r/Math.max(i.width,i.height)),a<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const r=Math.floor(a*i.width),n=Math.floor(a*i.height);void 0===l&&(l=R(r,n));const o=t?R(r,n):l;o.width=r,o.height=n;return o.getContext("2d").drawImage(e,0,0,r,n),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+i.width+"x"+i.height+") to ("+r+"x"+n+")."),o}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+i.width+"x"+i.height+")."),e}return e}function m(e){return e.generateMipmaps}function p(t){e.generateMipmap(t)}function g(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function h(r,a,i,n,o=!1){if(null!==r){if(void 0!==e[r])return e[r];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+r+"'")}let E=a;if(a===e.RED&&(i===e.FLOAT&&(E=e.R32F),i===e.HALF_FLOAT&&(E=e.R16F),i===e.UNSIGNED_BYTE&&(E=e.R8)),a===e.RED_INTEGER&&(i===e.UNSIGNED_BYTE&&(E=e.R8UI),i===e.UNSIGNED_SHORT&&(E=e.R16UI),i===e.UNSIGNED_INT&&(E=e.R32UI),i===e.BYTE&&(E=e.R8I),i===e.SHORT&&(E=e.R16I),i===e.INT&&(E=e.R32I)),a===e.RG&&(i===e.FLOAT&&(E=e.RG32F),i===e.HALF_FLOAT&&(E=e.RG16F),i===e.UNSIGNED_BYTE&&(E=e.RG8)),a===e.RG_INTEGER&&(i===e.UNSIGNED_BYTE&&(E=e.RG8UI),i===e.UNSIGNED_SHORT&&(E=e.RG16UI),i===e.UNSIGNED_INT&&(E=e.RG32UI),i===e.BYTE&&(E=e.RG8I),i===e.SHORT&&(E=e.RG16I),i===e.INT&&(E=e.RG32I)),a===e.RGB_INTEGER&&(i===e.UNSIGNED_BYTE&&(E=e.RGB8UI),i===e.UNSIGNED_SHORT&&(E=e.RGB16UI),i===e.UNSIGNED_INT&&(E=e.RGB32UI),i===e.BYTE&&(E=e.RGB8I),i===e.SHORT&&(E=e.RGB16I),i===e.INT&&(E=e.RGB32I)),a===e.RGBA_INTEGER&&(i===e.UNSIGNED_BYTE&&(E=e.RGBA8UI),i===e.UNSIGNED_SHORT&&(E=e.RGBA16UI),i===e.UNSIGNED_INT&&(E=e.RGBA32UI),i===e.BYTE&&(E=e.RGBA8I),i===e.SHORT&&(E=e.RGBA16I),i===e.INT&&(E=e.RGBA32I)),a===e.RGB&&i===e.UNSIGNED_INT_5_9_9_9_REV&&(E=e.RGB9_E5),a===e.RGBA){const t=o?LinearTransfer:ColorManagement.getTransfer(n);i===e.FLOAT&&(E=e.RGBA32F),i===e.HALF_FLOAT&&(E=e.RGBA16F),i===e.UNSIGNED_BYTE&&(E=t===SRGBTransfer?e.SRGB8_ALPHA8:e.RGBA8),i===e.UNSIGNED_SHORT_4_4_4_4&&(E=e.RGBA4),i===e.UNSIGNED_SHORT_5_5_5_1&&(E=e.RGB5_A1)}return E!==e.R16F&&E!==e.R32F&&E!==e.RG16F&&E!==e.RG32F&&E!==e.RGBA16F&&E!==e.RGBA32F||t.get("EXT_color_buffer_float"),E}function b(t,r){let a;return t?null===r||r===UnsignedIntType||r===UnsignedInt248Type?a=e.DEPTH24_STENCIL8:r===FloatType?a=e.DEPTH32F_STENCIL8:r===UnsignedShortType&&(a=e.DEPTH24_STENCIL8,console.warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===r||r===UnsignedIntType||r===UnsignedInt248Type?a=e.DEPTH_COMPONENT24:r===FloatType?a=e.DEPTH_COMPONENT32F:r===UnsignedShortType&&(a=e.DEPTH_COMPONENT16),a}function F(e,t){return!0===m(e)||e.isFramebufferTexture&&e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function c(e){const t=e.target;t.removeEventListener("dispose",c),function(e){const t=a.get(e);if(void 0===t.__webglInit)return;const r=e.source,i=f.get(r);if(i){const a=i[t.__cacheKey];a.usedTimes--,0===a.usedTimes&&U(e),0===Object.keys(i).length&&f.delete(r)}a.remove(e)}(t),t.isVideoTexture&&u.delete(t)}function A(t){const r=t.target;r.removeEventListener("dispose",A),function(t){const r=a.get(t);t.depthTexture&&(t.depthTexture.dispose(),a.remove(t.depthTexture));if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(r.__webglFramebuffer[t]))for(let a=0;a<r.__webglFramebuffer[t].length;a++)e.deleteFramebuffer(r.__webglFramebuffer[t][a]);else e.deleteFramebuffer(r.__webglFramebuffer[t]);r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer[t])}else{if(Array.isArray(r.__webglFramebuffer))for(let t=0;t<r.__webglFramebuffer.length;t++)e.deleteFramebuffer(r.__webglFramebuffer[t]);else e.deleteFramebuffer(r.__webglFramebuffer);if(r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer),r.__webglMultisampledFramebuffer&&e.deleteFramebuffer(r.__webglMultisampledFramebuffer),r.__webglColorRenderbuffer)for(let t=0;t<r.__webglColorRenderbuffer.length;t++)r.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(r.__webglColorRenderbuffer[t]);r.__webglDepthRenderbuffer&&e.deleteRenderbuffer(r.__webglDepthRenderbuffer)}const i=t.textures;for(let t=0,r=i.length;t<r;t++){const r=a.get(i[t]);r.__webglTexture&&(e.deleteTexture(r.__webglTexture),o.memory.textures--),a.remove(i[t])}a.remove(t)}(r)}function U(t){const r=a.get(t);e.deleteTexture(r.__webglTexture);const i=t.source;delete f.get(i)[r.__cacheKey],o.memory.textures--}let x=0;function D(t,i){const n=a.get(t);if(t.isVideoTexture&&function(e){const t=o.render.frame;u.get(e)!==t&&(u.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&!0!==t.isExternalTexture&&t.version>0&&n.__version!==t.version){const e=t.image;if(null===e)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void B(n,t,i);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}else t.isExternalTexture&&(n.__webglTexture=t.sourceTexture?t.sourceTexture:null);r.bindTexture(e.TEXTURE_2D,n.__webglTexture,e.TEXTURE0+i)}const w={[RepeatWrapping]:e.REPEAT,[ClampToEdgeWrapping]:e.CLAMP_TO_EDGE,[MirroredRepeatWrapping]:e.MIRRORED_REPEAT},M={[NearestFilter]:e.NEAREST,[NearestMipmapNearestFilter]:e.NEAREST_MIPMAP_NEAREST,[NearestMipmapLinearFilter]:e.NEAREST_MIPMAP_LINEAR,[LinearFilter]:e.LINEAR,[LinearMipmapNearestFilter]:e.LINEAR_MIPMAP_NEAREST,[LinearMipmapLinearFilter]:e.LINEAR_MIPMAP_LINEAR},N={[NeverCompare]:e.NEVER,[AlwaysCompare]:e.ALWAYS,[LessCompare]:e.LESS,[LessEqualCompare]:e.LEQUAL,[EqualCompare]:e.EQUAL,[GreaterEqualCompare]:e.GEQUAL,[GreaterCompare]:e.GREATER,[NotEqualCompare]:e.NOTEQUAL};function S(r,n){if(n.type!==FloatType||!1!==t.has("OES_texture_float_linear")||n.magFilter!==LinearFilter&&n.magFilter!==LinearMipmapNearestFilter&&n.magFilter!==NearestMipmapLinearFilter&&n.magFilter!==LinearMipmapLinearFilter&&n.minFilter!==LinearFilter&&n.minFilter!==LinearMipmapNearestFilter&&n.minFilter!==NearestMipmapLinearFilter&&n.minFilter!==LinearMipmapLinearFilter||console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(r,e.TEXTURE_WRAP_S,w[n.wrapS]),e.texParameteri(r,e.TEXTURE_WRAP_T,w[n.wrapT]),r!==e.TEXTURE_3D&&r!==e.TEXTURE_2D_ARRAY||e.texParameteri(r,e.TEXTURE_WRAP_R,w[n.wrapR]),e.texParameteri(r,e.TEXTURE_MAG_FILTER,M[n.magFilter]),e.texParameteri(r,e.TEXTURE_MIN_FILTER,M[n.minFilter]),n.compareFunction&&(e.texParameteri(r,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(r,e.TEXTURE_COMPARE_FUNC,N[n.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(n.magFilter===NearestFilter)return;if(n.minFilter!==NearestMipmapLinearFilter&&n.minFilter!==LinearMipmapLinearFilter)return;if(n.type===FloatType&&!1===t.has("OES_texture_float_linear"))return;if(n.anisotropy>1||a.get(n).__currentAnisotropy){const o=t.get("EXT_texture_filter_anisotropic");e.texParameterf(r,o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(n.anisotropy,i.getMaxAnisotropy())),a.get(n).__currentAnisotropy=n.anisotropy}}}function C(t,r){let a=!1;void 0===t.__webglInit&&(t.__webglInit=!0,r.addEventListener("dispose",c));const i=r.source;let n=f.get(i);void 0===n&&(n={},f.set(i,n));const E=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(r);if(E!==t.__cacheKey){void 0===n[E]&&(n[E]={texture:e.createTexture(),usedTimes:0},o.memory.textures++,a=!0),n[E].usedTimes++;const i=n[t.__cacheKey];void 0!==i&&(n[t.__cacheKey].usedTimes--,0===i.usedTimes&&U(r)),t.__cacheKey=E,t.__webglTexture=n[E].texture}return a}function I(e,t,r){return Math.floor(Math.floor(e/r)/t)}function B(t,o,E){let T=e.TEXTURE_2D;(o.isDataArrayTexture||o.isCompressedArrayTexture)&&(T=e.TEXTURE_2D_ARRAY),o.isData3DTexture&&(T=e.TEXTURE_3D);const _=C(t,o),u=o.source;r.bindTexture(T,t.__webglTexture,e.TEXTURE0+E);const l=a.get(u);if(u.version!==l.__version||!0===_){r.activeTexture(e.TEXTURE0+E);const t=ColorManagement.getPrimaries(ColorManagement.workingColorSpace),a=o.colorSpace===NoColorSpace?null:ColorManagement.getPrimaries(o.colorSpace),f=o.colorSpace===NoColorSpace||t===a?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,o.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,o.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,f);let s=d(o.image,!1,i.maxTextureSize);s=W(o,s);const R=n.convert(o.format,o.colorSpace),g=n.convert(o.type);let c,A=h(o.internalFormat,R,g,o.colorSpace,o.isVideoTexture);S(T,o);const U=o.mipmaps,x=!0!==o.isVideoTexture,D=void 0===l.__version||!0===_,w=u.dataReady,M=F(o,s);if(o.isDepthTexture)A=b(o.format===DepthStencilFormat,o.type),D&&(x?r.texStorage2D(e.TEXTURE_2D,1,A,s.width,s.height):r.texImage2D(e.TEXTURE_2D,0,A,s.width,s.height,0,R,g,null));else if(o.isDataTexture)if(U.length>0){x&&D&&r.texStorage2D(e.TEXTURE_2D,M,A,U[0].width,U[0].height);for(let t=0,a=U.length;t<a;t++)c=U[t],x?w&&r.texSubImage2D(e.TEXTURE_2D,t,0,0,c.width,c.height,R,g,c.data):r.texImage2D(e.TEXTURE_2D,t,A,c.width,c.height,0,R,g,c.data);o.generateMipmaps=!1}else x?(D&&r.texStorage2D(e.TEXTURE_2D,M,A,s.width,s.height),w&&function(t,a,i,n){const o=t.updateRanges;if(0===o.length)r.texSubImage2D(e.TEXTURE_2D,0,0,0,a.width,a.height,i,n,a.data);else{o.sort(((e,t)=>e.start-t.start));let E=0;for(let e=1;e<o.length;e++){const t=o[E],r=o[e],i=t.start+t.count,n=I(r.start,a.width,4),T=I(t.start,a.width,4);r.start<=i+1&&n===T&&I(r.start+r.count-1,a.width,4)===n?t.count=Math.max(t.count,r.start+r.count-t.start):(++E,o[E]=r)}o.length=E+1;const T=e.getParameter(e.UNPACK_ROW_LENGTH),_=e.getParameter(e.UNPACK_SKIP_PIXELS),u=e.getParameter(e.UNPACK_SKIP_ROWS);e.pixelStorei(e.UNPACK_ROW_LENGTH,a.width);for(let t=0,E=o.length;t<E;t++){const E=o[t],T=Math.floor(E.start/4),_=Math.ceil(E.count/4),u=T%a.width,l=Math.floor(T/a.width),f=_,s=1;e.pixelStorei(e.UNPACK_SKIP_PIXELS,u),e.pixelStorei(e.UNPACK_SKIP_ROWS,l),r.texSubImage2D(e.TEXTURE_2D,0,u,l,f,s,i,n,a.data)}t.clearUpdateRanges(),e.pixelStorei(e.UNPACK_ROW_LENGTH,T),e.pixelStorei(e.UNPACK_SKIP_PIXELS,_),e.pixelStorei(e.UNPACK_SKIP_ROWS,u)}}(o,s,R,g)):r.texImage2D(e.TEXTURE_2D,0,A,s.width,s.height,0,R,g,s.data);else if(o.isCompressedTexture)if(o.isCompressedArrayTexture){x&&D&&r.texStorage3D(e.TEXTURE_2D_ARRAY,M,A,U[0].width,U[0].height,s.depth);for(let t=0,a=U.length;t<a;t++)if(c=U[t],o.format!==RGBAFormat)if(null!==R)if(x){if(w)if(o.layerUpdates.size>0){const a=getByteLength(c.width,c.height,o.format,o.type);for(const i of o.layerUpdates){const n=c.data.subarray(i*a/c.data.BYTES_PER_ELEMENT,(i+1)*a/c.data.BYTES_PER_ELEMENT);r.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,i,c.width,c.height,1,R,n)}o.clearLayerUpdates()}else r.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,c.width,c.height,s.depth,R,c.data)}else r.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,A,c.width,c.height,s.depth,0,c.data,0,0);else console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else x?w&&r.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,c.width,c.height,s.depth,R,g,c.data):r.texImage3D(e.TEXTURE_2D_ARRAY,t,A,c.width,c.height,s.depth,0,R,g,c.data)}else{x&&D&&r.texStorage2D(e.TEXTURE_2D,M,A,U[0].width,U[0].height);for(let t=0,a=U.length;t<a;t++)c=U[t],o.format!==RGBAFormat?null!==R?x?w&&r.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,c.width,c.height,R,c.data):r.compressedTexImage2D(e.TEXTURE_2D,t,A,c.width,c.height,0,c.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):x?w&&r.texSubImage2D(e.TEXTURE_2D,t,0,0,c.width,c.height,R,g,c.data):r.texImage2D(e.TEXTURE_2D,t,A,c.width,c.height,0,R,g,c.data)}else if(o.isDataArrayTexture)if(x){if(D&&r.texStorage3D(e.TEXTURE_2D_ARRAY,M,A,s.width,s.height,s.depth),w)if(o.layerUpdates.size>0){const t=getByteLength(s.width,s.height,o.format,o.type);for(const a of o.layerUpdates){const i=s.data.subarray(a*t/s.data.BYTES_PER_ELEMENT,(a+1)*t/s.data.BYTES_PER_ELEMENT);r.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,a,s.width,s.height,1,R,g,i)}o.clearLayerUpdates()}else r.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,s.width,s.height,s.depth,R,g,s.data)}else r.texImage3D(e.TEXTURE_2D_ARRAY,0,A,s.width,s.height,s.depth,0,R,g,s.data);else if(o.isData3DTexture)x?(D&&r.texStorage3D(e.TEXTURE_3D,M,A,s.width,s.height,s.depth),w&&r.texSubImage3D(e.TEXTURE_3D,0,0,0,0,s.width,s.height,s.depth,R,g,s.data)):r.texImage3D(e.TEXTURE_3D,0,A,s.width,s.height,s.depth,0,R,g,s.data);else if(o.isFramebufferTexture){if(D)if(x)r.texStorage2D(e.TEXTURE_2D,M,A,s.width,s.height);else{let t=s.width,a=s.height;for(let i=0;i<M;i++)r.texImage2D(e.TEXTURE_2D,i,A,t,a,0,R,g,null),t>>=1,a>>=1}}else if(U.length>0){if(x&&D){const t=Y(U[0]);r.texStorage2D(e.TEXTURE_2D,M,A,t.width,t.height)}for(let t=0,a=U.length;t<a;t++)c=U[t],x?w&&r.texSubImage2D(e.TEXTURE_2D,t,0,0,R,g,c):r.texImage2D(e.TEXTURE_2D,t,A,R,g,c);o.generateMipmaps=!1}else if(x){if(D){const t=Y(s);r.texStorage2D(e.TEXTURE_2D,M,A,t.width,t.height)}w&&r.texSubImage2D(e.TEXTURE_2D,0,0,0,R,g,s)}else r.texImage2D(e.TEXTURE_2D,0,A,R,g,s);m(o)&&p(T),l.__version=u.version,o.onUpdate&&o.onUpdate(o)}t.__version=o.version}function L(t,i,o,T,_,u){const l=n.convert(o.format,o.colorSpace),f=n.convert(o.type),s=h(o.internalFormat,l,f,o.colorSpace),R=a.get(i),d=a.get(o);if(d.__renderTarget=i,!R.__hasExternalTextures){const t=Math.max(1,i.width>>u),a=Math.max(1,i.height>>u);_===e.TEXTURE_3D||_===e.TEXTURE_2D_ARRAY?r.texImage3D(_,u,s,t,a,i.depth,0,l,f,null):r.texImage2D(_,u,s,t,a,0,l,f,null)}r.bindFramebuffer(e.FRAMEBUFFER,t),H(i)?E.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,T,_,d.__webglTexture,0,v(i)):(_===e.TEXTURE_2D||_>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&_<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,T,_,d.__webglTexture,u),r.bindFramebuffer(e.FRAMEBUFFER,null)}function P(t,r,a){if(e.bindRenderbuffer(e.RENDERBUFFER,t),r.depthBuffer){const i=r.depthTexture,n=i&&i.isDepthTexture?i.type:null,o=b(r.stencilBuffer,n),T=r.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,_=v(r);H(r)?E.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,_,o,r.width,r.height):a?e.renderbufferStorageMultisample(e.RENDERBUFFER,_,o,r.width,r.height):e.renderbufferStorage(e.RENDERBUFFER,o,r.width,r.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,T,e.RENDERBUFFER,t)}else{const t=r.textures;for(let i=0;i<t.length;i++){const o=t[i],T=n.convert(o.format,o.colorSpace),_=n.convert(o.type),u=h(o.internalFormat,T,_,o.colorSpace),l=v(r);a&&!1===H(r)?e.renderbufferStorageMultisample(e.RENDERBUFFER,l,u,r.width,r.height):H(r)?E.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,l,u,r.width,r.height):e.renderbufferStorage(e.RENDERBUFFER,u,r.width,r.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function X(t,i){if(i&&i.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(r.bindFramebuffer(e.FRAMEBUFFER,t),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const n=a.get(i.depthTexture);n.__renderTarget=i,n.__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),D(i.depthTexture,0);const o=n.__webglTexture,T=v(i);if(i.depthTexture.format===DepthFormat)H(i)?E.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0,T):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0);else{if(i.depthTexture.format!==DepthStencilFormat)throw new Error("Unknown depthTexture format");H(i)?E.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,o,0,T):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,o,0)}}function G(t){const i=a.get(t),n=!0===t.isWebGLCubeRenderTarget;if(i.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(i.__depthDisposeCallback&&i.__depthDisposeCallback(),e){const t=()=>{delete i.__boundDepthTexture,delete i.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),i.__depthDisposeCallback=t}i.__boundDepthTexture=e}if(t.depthTexture&&!i.__autoAllocateDepthBuffer){if(n)throw new Error("target.depthTexture not supported in Cube render targets");const e=t.texture.mipmaps;e&&e.length>0?X(i.__webglFramebuffer[0],t):X(i.__webglFramebuffer,t)}else if(n){i.__webglDepthbuffer=[];for(let a=0;a<6;a++)if(r.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer[a]),void 0===i.__webglDepthbuffer[a])i.__webglDepthbuffer[a]=e.createRenderbuffer(),P(i.__webglDepthbuffer[a],t,!1);else{const r=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,n=i.__webglDepthbuffer[a];e.bindRenderbuffer(e.RENDERBUFFER,n),e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,n)}}else{const a=t.texture.mipmaps;if(a&&a.length>0?r.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer[0]):r.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer),void 0===i.__webglDepthbuffer)i.__webglDepthbuffer=e.createRenderbuffer(),P(i.__webglDepthbuffer,t,!1);else{const r=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,a=i.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,a),e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,a)}}r.bindFramebuffer(e.FRAMEBUFFER,null)}const O=[],y=[];function v(e){return Math.min(i.maxSamples,e.samples)}function H(e){const r=a.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==r.__useRenderToTexture}function W(e,t){const r=e.colorSpace,a=e.format,i=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||r!==LinearSRGBColorSpace&&r!==NoColorSpace&&(ColorManagement.getTransfer(r)===SRGBTransfer?a===RGBAFormat&&i===UnsignedByteType||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",r)),t}function Y(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(_.width=e.naturalWidth||e.width,_.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(_.width=e.displayWidth,_.height=e.displayHeight):(_.width=e.width,_.height=e.height),_}this.allocateTextureUnit=function(){const e=x;return e>=i.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+i.maxTextures),x+=1,e},this.resetTextureUnits=function(){x=0},this.setTexture2D=D,this.setTexture2DArray=function(t,i){const n=a.get(t);!1===t.isRenderTargetTexture&&t.version>0&&n.__version!==t.version?B(n,t,i):r.bindTexture(e.TEXTURE_2D_ARRAY,n.__webglTexture,e.TEXTURE0+i)},this.setTexture3D=function(t,i){const n=a.get(t);!1===t.isRenderTargetTexture&&t.version>0&&n.__version!==t.version?B(n,t,i):r.bindTexture(e.TEXTURE_3D,n.__webglTexture,e.TEXTURE0+i)},this.setTextureCube=function(t,o){const E=a.get(t);t.version>0&&E.__version!==t.version?function(t,o,E){if(6!==o.image.length)return;const T=C(t,o),_=o.source;r.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+E);const u=a.get(_);if(_.version!==u.__version||!0===T){r.activeTexture(e.TEXTURE0+E);const t=ColorManagement.getPrimaries(ColorManagement.workingColorSpace),a=o.colorSpace===NoColorSpace?null:ColorManagement.getPrimaries(o.colorSpace),l=o.colorSpace===NoColorSpace||t===a?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,o.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,o.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,l);const f=o.isCompressedTexture||o.image[0].isCompressedTexture,s=o.image[0]&&o.image[0].isDataTexture,R=[];for(let e=0;e<6;e++)R[e]=f||s?s?o.image[e].image:o.image[e]:d(o.image[e],!0,i.maxCubemapSize),R[e]=W(o,R[e]);const g=R[0],b=n.convert(o.format,o.colorSpace),c=n.convert(o.type),A=h(o.internalFormat,b,c,o.colorSpace),U=!0!==o.isVideoTexture,x=void 0===u.__version||!0===T,D=_.dataReady;let w,M=F(o,g);if(S(e.TEXTURE_CUBE_MAP,o),f){U&&x&&r.texStorage2D(e.TEXTURE_CUBE_MAP,M,A,g.width,g.height);for(let t=0;t<6;t++){w=R[t].mipmaps;for(let a=0;a<w.length;a++){const i=w[a];o.format!==RGBAFormat?null!==b?U?D&&r.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,0,0,i.width,i.height,b,i.data):r.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,A,i.width,i.height,0,i.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):U?D&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,0,0,i.width,i.height,b,c,i.data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,A,i.width,i.height,0,b,c,i.data)}}}else{if(w=o.mipmaps,U&&x){w.length>0&&M++;const t=Y(R[0]);r.texStorage2D(e.TEXTURE_CUBE_MAP,M,A,t.width,t.height)}for(let t=0;t<6;t++)if(s){U?D&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,R[t].width,R[t].height,b,c,R[t].data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,A,R[t].width,R[t].height,0,b,c,R[t].data);for(let a=0;a<w.length;a++){const i=w[a].image[t].image;U?D&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,0,0,i.width,i.height,b,c,i.data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,A,i.width,i.height,0,b,c,i.data)}}else{U?D&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,b,c,R[t]):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,A,b,c,R[t]);for(let a=0;a<w.length;a++){const i=w[a];U?D&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,0,0,b,c,i.image[t]):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,A,b,c,i.image[t])}}}m(o)&&p(e.TEXTURE_CUBE_MAP),u.__version=_.version,o.onUpdate&&o.onUpdate(o)}t.__version=o.version}(E,t,o):r.bindTexture(e.TEXTURE_CUBE_MAP,E.__webglTexture,e.TEXTURE0+o)},this.rebindTextures=function(t,r,i){const n=a.get(t);void 0!==r&&L(n.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==i&&G(t)},this.setupRenderTarget=function(t){const i=t.texture,E=a.get(t),T=a.get(i);t.addEventListener("dispose",A);const _=t.textures,u=!0===t.isWebGLCubeRenderTarget,l=_.length>1;if(l||(void 0===T.__webglTexture&&(T.__webglTexture=e.createTexture()),T.__version=i.version,o.memory.textures++),u){E.__webglFramebuffer=[];for(let t=0;t<6;t++)if(i.mipmaps&&i.mipmaps.length>0){E.__webglFramebuffer[t]=[];for(let r=0;r<i.mipmaps.length;r++)E.__webglFramebuffer[t][r]=e.createFramebuffer()}else E.__webglFramebuffer[t]=e.createFramebuffer()}else{if(i.mipmaps&&i.mipmaps.length>0){E.__webglFramebuffer=[];for(let t=0;t<i.mipmaps.length;t++)E.__webglFramebuffer[t]=e.createFramebuffer()}else E.__webglFramebuffer=e.createFramebuffer();if(l)for(let t=0,r=_.length;t<r;t++){const r=a.get(_[t]);void 0===r.__webglTexture&&(r.__webglTexture=e.createTexture(),o.memory.textures++)}if(t.samples>0&&!1===H(t)){E.__webglMultisampledFramebuffer=e.createFramebuffer(),E.__webglColorRenderbuffer=[],r.bindFramebuffer(e.FRAMEBUFFER,E.__webglMultisampledFramebuffer);for(let r=0;r<_.length;r++){const a=_[r];E.__webglColorRenderbuffer[r]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,E.__webglColorRenderbuffer[r]);const i=n.convert(a.format,a.colorSpace),o=n.convert(a.type),T=h(a.internalFormat,i,o,a.colorSpace,!0===t.isXRRenderTarget),u=v(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,u,T,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+r,e.RENDERBUFFER,E.__webglColorRenderbuffer[r])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(E.__webglDepthRenderbuffer=e.createRenderbuffer(),P(E.__webglDepthRenderbuffer,t,!0)),r.bindFramebuffer(e.FRAMEBUFFER,null)}}if(u){r.bindTexture(e.TEXTURE_CUBE_MAP,T.__webglTexture),S(e.TEXTURE_CUBE_MAP,i);for(let r=0;r<6;r++)if(i.mipmaps&&i.mipmaps.length>0)for(let a=0;a<i.mipmaps.length;a++)L(E.__webglFramebuffer[r][a],t,i,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,a);else L(E.__webglFramebuffer[r],t,i,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,0);m(i)&&p(e.TEXTURE_CUBE_MAP),r.unbindTexture()}else if(l){for(let i=0,n=_.length;i<n;i++){const n=_[i],o=a.get(n);let T=e.TEXTURE_2D;(t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(T=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),r.bindTexture(T,o.__webglTexture),S(T,n),L(E.__webglFramebuffer,t,n,e.COLOR_ATTACHMENT0+i,T,0),m(n)&&p(T)}r.unbindTexture()}else{let a=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(a=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),r.bindTexture(a,T.__webglTexture),S(a,i),i.mipmaps&&i.mipmaps.length>0)for(let r=0;r<i.mipmaps.length;r++)L(E.__webglFramebuffer[r],t,i,e.COLOR_ATTACHMENT0,a,r);else L(E.__webglFramebuffer,t,i,e.COLOR_ATTACHMENT0,a,0);m(i)&&p(a),r.unbindTexture()}t.depthBuffer&&G(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let i=0,n=t.length;i<n;i++){const n=t[i];if(m(n)){const t=g(e),i=a.get(n).__webglTexture;r.bindTexture(t,i),p(t),r.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===H(t)){const i=t.textures,n=t.width,o=t.height;let E=e.COLOR_BUFFER_BIT;const _=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,u=a.get(t),l=i.length>1;if(l)for(let t=0;t<i.length;t++)r.bindFramebuffer(e.FRAMEBUFFER,u.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),r.bindFramebuffer(e.FRAMEBUFFER,u.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);r.bindFramebuffer(e.READ_FRAMEBUFFER,u.__webglMultisampledFramebuffer);const f=t.texture.mipmaps;f&&f.length>0?r.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglFramebuffer[0]):r.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglFramebuffer);for(let r=0;r<i.length;r++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(E|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(E|=e.STENCIL_BUFFER_BIT)),l){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,u.__webglColorRenderbuffer[r]);const t=a.get(i[r]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,n,o,0,0,n,o,E,e.NEAREST),!0===T&&(O.length=0,y.length=0,O.push(e.COLOR_ATTACHMENT0+r),t.depthBuffer&&!1===t.resolveDepthBuffer&&(O.push(_),y.push(_),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,y)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,O))}if(r.bindFramebuffer(e.READ_FRAMEBUFFER,null),r.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),l)for(let t=0;t<i.length;t++){r.bindFramebuffer(e.FRAMEBUFFER,u.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,u.__webglColorRenderbuffer[t]);const n=a.get(i[t]).__webglTexture;r.bindFramebuffer(e.FRAMEBUFFER,u.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,n,0)}r.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&T){const r=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[r])}},this.setupDepthRenderbuffer=G,this.setupFrameBufferTexture=L,this.useMultisampledRTT=H}export{WebGLTextures};
//# sourceMappingURL=WebGLTextures.js.map