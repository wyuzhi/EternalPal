import{CubeTexture}from"../../textures/CubeTexture.js";import{Texture}from"../../textures/Texture.js";import{DataArrayTexture}from"../../textures/DataArrayTexture.js";import{Data3DTexture}from"../../textures/Data3DTexture.js";import{DepthTexture}from"../../textures/DepthTexture.js";import{LessEqualCompare}from"../../constants.js";const emptyTexture=new Texture,emptyShadowTexture=new DepthTexture(1,1),emptyArrayTexture=new DataArrayTexture,empty3dTexture=new Data3DTexture,emptyCubeTexture=new CubeTexture,arrayCacheF32=[],arrayCacheI32=[],mat4array=new Float32Array(16),mat3array=new Float32Array(9),mat2array=new Float32Array(4);function flatten(e,r,t){const a=e[0];if(a<=0||a>0)return e;const s=r*t;let i=arrayCacheF32[s];if(void 0===i&&(i=new Float32Array(s),arrayCacheF32[s]=i),0!==r){a.toArray(i,0);for(let a=1,s=0;a!==r;++a)s+=t,e[a].toArray(i,s)}return i}function arraysEqual(e,r){if(e.length!==r.length)return!1;for(let t=0,a=e.length;t<a;t++)if(e[t]!==r[t])return!1;return!0}function copyArray(e,r){for(let t=0,a=r.length;t<a;t++)e[t]=r[t]}function allocTexUnits(e,r){let t=arrayCacheI32[r];void 0===t&&(t=new Int32Array(r),arrayCacheI32[r]=t);for(let a=0;a!==r;++a)t[a]=e.allocateTextureUnit();return t}function setValueV1f(e,r){const t=this.cache;t[0]!==r&&(e.uniform1f(this.addr,r),t[0]=r)}function setValueV2f(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y||(e.uniform2f(this.addr,r.x,r.y),t[0]=r.x,t[1]=r.y);else{if(arraysEqual(t,r))return;e.uniform2fv(this.addr,r),copyArray(t,r)}}function setValueV3f(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y&&t[2]===r.z||(e.uniform3f(this.addr,r.x,r.y,r.z),t[0]=r.x,t[1]=r.y,t[2]=r.z);else if(void 0!==r.r)t[0]===r.r&&t[1]===r.g&&t[2]===r.b||(e.uniform3f(this.addr,r.r,r.g,r.b),t[0]=r.r,t[1]=r.g,t[2]=r.b);else{if(arraysEqual(t,r))return;e.uniform3fv(this.addr,r),copyArray(t,r)}}function setValueV4f(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y&&t[2]===r.z&&t[3]===r.w||(e.uniform4f(this.addr,r.x,r.y,r.z,r.w),t[0]=r.x,t[1]=r.y,t[2]=r.z,t[3]=r.w);else{if(arraysEqual(t,r))return;e.uniform4fv(this.addr,r),copyArray(t,r)}}function setValueM2(e,r){const t=this.cache,a=r.elements;if(void 0===a){if(arraysEqual(t,r))return;e.uniformMatrix2fv(this.addr,!1,r),copyArray(t,r)}else{if(arraysEqual(t,a))return;mat2array.set(a),e.uniformMatrix2fv(this.addr,!1,mat2array),copyArray(t,a)}}function setValueM3(e,r){const t=this.cache,a=r.elements;if(void 0===a){if(arraysEqual(t,r))return;e.uniformMatrix3fv(this.addr,!1,r),copyArray(t,r)}else{if(arraysEqual(t,a))return;mat3array.set(a),e.uniformMatrix3fv(this.addr,!1,mat3array),copyArray(t,a)}}function setValueM4(e,r){const t=this.cache,a=r.elements;if(void 0===a){if(arraysEqual(t,r))return;e.uniformMatrix4fv(this.addr,!1,r),copyArray(t,r)}else{if(arraysEqual(t,a))return;mat4array.set(a),e.uniformMatrix4fv(this.addr,!1,mat4array),copyArray(t,a)}}function setValueV1i(e,r){const t=this.cache;t[0]!==r&&(e.uniform1i(this.addr,r),t[0]=r)}function setValueV2i(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y||(e.uniform2i(this.addr,r.x,r.y),t[0]=r.x,t[1]=r.y);else{if(arraysEqual(t,r))return;e.uniform2iv(this.addr,r),copyArray(t,r)}}function setValueV3i(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y&&t[2]===r.z||(e.uniform3i(this.addr,r.x,r.y,r.z),t[0]=r.x,t[1]=r.y,t[2]=r.z);else{if(arraysEqual(t,r))return;e.uniform3iv(this.addr,r),copyArray(t,r)}}function setValueV4i(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y&&t[2]===r.z&&t[3]===r.w||(e.uniform4i(this.addr,r.x,r.y,r.z,r.w),t[0]=r.x,t[1]=r.y,t[2]=r.z,t[3]=r.w);else{if(arraysEqual(t,r))return;e.uniform4iv(this.addr,r),copyArray(t,r)}}function setValueV1ui(e,r){const t=this.cache;t[0]!==r&&(e.uniform1ui(this.addr,r),t[0]=r)}function setValueV2ui(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y||(e.uniform2ui(this.addr,r.x,r.y),t[0]=r.x,t[1]=r.y);else{if(arraysEqual(t,r))return;e.uniform2uiv(this.addr,r),copyArray(t,r)}}function setValueV3ui(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y&&t[2]===r.z||(e.uniform3ui(this.addr,r.x,r.y,r.z),t[0]=r.x,t[1]=r.y,t[2]=r.z);else{if(arraysEqual(t,r))return;e.uniform3uiv(this.addr,r),copyArray(t,r)}}function setValueV4ui(e,r){const t=this.cache;if(void 0!==r.x)t[0]===r.x&&t[1]===r.y&&t[2]===r.z&&t[3]===r.w||(e.uniform4ui(this.addr,r.x,r.y,r.z,r.w),t[0]=r.x,t[1]=r.y,t[2]=r.z,t[3]=r.w);else{if(arraysEqual(t,r))return;e.uniform4uiv(this.addr,r),copyArray(t,r)}}function setValueT1(e,r,t){const a=this.cache,s=t.allocateTextureUnit();let i;a[0]!==s&&(e.uniform1i(this.addr,s),a[0]=s),this.type===e.SAMPLER_2D_SHADOW?(emptyShadowTexture.compareFunction=LessEqualCompare,i=emptyShadowTexture):i=emptyTexture,t.setTexture2D(r||i,s)}function setValueT3D1(e,r,t){const a=this.cache,s=t.allocateTextureUnit();a[0]!==s&&(e.uniform1i(this.addr,s),a[0]=s),t.setTexture3D(r||empty3dTexture,s)}function setValueT6(e,r,t){const a=this.cache,s=t.allocateTextureUnit();a[0]!==s&&(e.uniform1i(this.addr,s),a[0]=s),t.setTextureCube(r||emptyCubeTexture,s)}function setValueT2DArray1(e,r,t){const a=this.cache,s=t.allocateTextureUnit();a[0]!==s&&(e.uniform1i(this.addr,s),a[0]=s),t.setTexture2DArray(r||emptyArrayTexture,s)}function getSingularSetter(e){switch(e){case 5126:return setValueV1f;case 35664:return setValueV2f;case 35665:return setValueV3f;case 35666:return setValueV4f;case 35674:return setValueM2;case 35675:return setValueM3;case 35676:return setValueM4;case 5124:case 35670:return setValueV1i;case 35667:case 35671:return setValueV2i;case 35668:case 35672:return setValueV3i;case 35669:case 35673:return setValueV4i;case 5125:return setValueV1ui;case 36294:return setValueV2ui;case 36295:return setValueV3ui;case 36296:return setValueV4ui;case 35678:case 36198:case 36298:case 36306:case 35682:return setValueT1;case 35679:case 36299:case 36307:return setValueT3D1;case 35680:case 36300:case 36308:case 36293:return setValueT6;case 36289:case 36303:case 36311:case 36292:return setValueT2DArray1}}function setValueV1fArray(e,r){e.uniform1fv(this.addr,r)}function setValueV2fArray(e,r){const t=flatten(r,this.size,2);e.uniform2fv(this.addr,t)}function setValueV3fArray(e,r){const t=flatten(r,this.size,3);e.uniform3fv(this.addr,t)}function setValueV4fArray(e,r){const t=flatten(r,this.size,4);e.uniform4fv(this.addr,t)}function setValueM2Array(e,r){const t=flatten(r,this.size,4);e.uniformMatrix2fv(this.addr,!1,t)}function setValueM3Array(e,r){const t=flatten(r,this.size,9);e.uniformMatrix3fv(this.addr,!1,t)}function setValueM4Array(e,r){const t=flatten(r,this.size,16);e.uniformMatrix4fv(this.addr,!1,t)}function setValueV1iArray(e,r){e.uniform1iv(this.addr,r)}function setValueV2iArray(e,r){e.uniform2iv(this.addr,r)}function setValueV3iArray(e,r){e.uniform3iv(this.addr,r)}function setValueV4iArray(e,r){e.uniform4iv(this.addr,r)}function setValueV1uiArray(e,r){e.uniform1uiv(this.addr,r)}function setValueV2uiArray(e,r){e.uniform2uiv(this.addr,r)}function setValueV3uiArray(e,r){e.uniform3uiv(this.addr,r)}function setValueV4uiArray(e,r){e.uniform4uiv(this.addr,r)}function setValueT1Array(e,r,t){const a=this.cache,s=r.length,i=allocTexUnits(t,s);arraysEqual(a,i)||(e.uniform1iv(this.addr,i),copyArray(a,i));for(let e=0;e!==s;++e)t.setTexture2D(r[e]||emptyTexture,i[e])}function setValueT3DArray(e,r,t){const a=this.cache,s=r.length,i=allocTexUnits(t,s);arraysEqual(a,i)||(e.uniform1iv(this.addr,i),copyArray(a,i));for(let e=0;e!==s;++e)t.setTexture3D(r[e]||empty3dTexture,i[e])}function setValueT6Array(e,r,t){const a=this.cache,s=r.length,i=allocTexUnits(t,s);arraysEqual(a,i)||(e.uniform1iv(this.addr,i),copyArray(a,i));for(let e=0;e!==s;++e)t.setTextureCube(r[e]||emptyCubeTexture,i[e])}function setValueT2DArrayArray(e,r,t){const a=this.cache,s=r.length,i=allocTexUnits(t,s);arraysEqual(a,i)||(e.uniform1iv(this.addr,i),copyArray(a,i));for(let e=0;e!==s;++e)t.setTexture2DArray(r[e]||emptyArrayTexture,i[e])}function getPureArraySetter(e){switch(e){case 5126:return setValueV1fArray;case 35664:return setValueV2fArray;case 35665:return setValueV3fArray;case 35666:return setValueV4fArray;case 35674:return setValueM2Array;case 35675:return setValueM3Array;case 35676:return setValueM4Array;case 5124:case 35670:return setValueV1iArray;case 35667:case 35671:return setValueV2iArray;case 35668:case 35672:return setValueV3iArray;case 35669:case 35673:return setValueV4iArray;case 5125:return setValueV1uiArray;case 36294:return setValueV2uiArray;case 36295:return setValueV3uiArray;case 36296:return setValueV4uiArray;case 35678:case 36198:case 36298:case 36306:case 35682:return setValueT1Array;case 35679:case 36299:case 36307:return setValueT3DArray;case 35680:case 36300:case 36308:case 36293:return setValueT6Array;case 36289:case 36303:case 36311:case 36292:return setValueT2DArrayArray}}class SingleUniform{constructor(e,r,t){this.id=e,this.addr=t,this.cache=[],this.type=r.type,this.setValue=getSingularSetter(r.type)}}class PureArrayUniform{constructor(e,r,t){this.id=e,this.addr=t,this.cache=[],this.type=r.type,this.size=r.size,this.setValue=getPureArraySetter(r.type)}}class StructuredUniform{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,r,t){const a=this.seq;for(let s=0,i=a.length;s!==i;++s){const i=a[s];i.setValue(e,r[i.id],t)}}}const RePathPart=/(\w+)(\])?(\[|\.)?/g;function addUniform(e,r){e.seq.push(r),e.map[r.id]=r}function parseUniform(e,r,t){const a=e.name,s=a.length;for(RePathPart.lastIndex=0;;){const i=RePathPart.exec(a),u=RePathPart.lastIndex;let n=i[1];const c="]"===i[2],o=i[3];if(c&&(n|=0),void 0===o||"["===o&&u+2===s){addUniform(t,void 0===o?new SingleUniform(n,e,r):new PureArrayUniform(n,e,r));break}{let e=t.map[n];void 0===e&&(e=new StructuredUniform(n),addUniform(t,e)),t=e}}}class WebGLUniforms{constructor(e,r){this.seq=[],this.map={};const t=e.getProgramParameter(r,e.ACTIVE_UNIFORMS);for(let a=0;a<t;++a){const t=e.getActiveUniform(r,a);parseUniform(t,e.getUniformLocation(r,t.name),this)}}setValue(e,r,t,a){const s=this.map[r];void 0!==s&&s.setValue(e,t,a)}setOptional(e,r,t){const a=r[t];void 0!==a&&this.setValue(e,t,a)}static upload(e,r,t,a){for(let s=0,i=r.length;s!==i;++s){const i=r[s],u=t[i.id];!1!==u.needsUpdate&&i.setValue(e,u.value,a)}}static seqWithValue(e,r){const t=[];for(let a=0,s=e.length;a!==s;++a){const s=e[a];s.id in r&&t.push(s)}return t}}export{WebGLUniforms};
//# sourceMappingURL=WebGLUniforms.js.map