function WebGLUniformsGroups(e,t,n,r){let o={},a={},s=[];const i=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function u(e,t,n,r){const o=e.value,a=t+"_"+n;if(void 0===r[a])return r[a]="number"==typeof o||"boolean"==typeof o?o:o.clone(),!0;{const e=r[a];if("number"==typeof o||"boolean"==typeof o){if(e!==o)return r[a]=o,!0}else if(!1===e.equals(o))return e.copy(o),!0}return!1}function f(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),t}function _(t){const n=t.target;n.removeEventListener("dispose",_);const r=s.indexOf(n.__bindingPointIndex);s.splice(r,1),e.deleteBuffer(o[n.id]),delete o[n.id],delete a[n.id]}return{bind:function(e,t){const n=t.program;r.uniformBlockBinding(e,n)},update:function(n,d){let l=o[n.id];void 0===l&&(!function(e){const t=e.uniforms;let n=0;const r=16;for(let e=0,o=t.length;e<o;e++){const o=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0,t=o.length;e<t;e++){const t=o[e],a=Array.isArray(t.value)?t.value:[t.value];for(let e=0,o=a.length;e<o;e++){const o=f(a[e]),s=n%r,i=s%o.boundary,u=s+i;n+=i,0!==u&&r-u<o.storage&&(n+=r-u),t.__data=new Float32Array(o.storage/Float32Array.BYTES_PER_ELEMENT),t.__offset=n,n+=o.storage}}}const o=n%r;o>0&&(n+=r-o);e.__size=n,e.__cache={}}(n),l=function(t){const n=function(){for(let e=0;e<i;e++)if(-1===s.indexOf(e))return s.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();t.__bindingPointIndex=n;const r=e.createBuffer(),o=t.__size,a=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,r),e.bufferData(e.UNIFORM_BUFFER,o,a),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,n,r),r}(n),o[n.id]=l,n.addEventListener("dispose",_));const c=d.program;r.updateUBOMapping(n,c);const b=t.render.frame;a[n.id]!==b&&(!function(t){const n=o[t.id],r=t.uniforms,a=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,n);for(let t=0,n=r.length;t<n;t++){const n=Array.isArray(r[t])?r[t]:[r[t]];for(let r=0,o=n.length;r<o;r++){const o=n[r];if(!0===u(o,t,r,a)){const t=o.__offset,n=Array.isArray(o.value)?o.value:[o.value];let r=0;for(let a=0;a<n.length;a++){const s=n[a],i=f(s);"number"==typeof s||"boolean"==typeof s?(o.__data[0]=s,e.bufferSubData(e.UNIFORM_BUFFER,t+r,o.__data)):s.isMatrix3?(o.__data[0]=s.elements[0],o.__data[1]=s.elements[1],o.__data[2]=s.elements[2],o.__data[3]=0,o.__data[4]=s.elements[3],o.__data[5]=s.elements[4],o.__data[6]=s.elements[5],o.__data[7]=0,o.__data[8]=s.elements[6],o.__data[9]=s.elements[7],o.__data[10]=s.elements[8],o.__data[11]=0):(s.toArray(o.__data,r),r+=i.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,o.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(n),a[n.id]=b)},dispose:function(){for(const t in o)e.deleteBuffer(o[t]);s=[],o={},a={}}}}export{WebGLUniformsGroups};
//# sourceMappingURL=WebGLUniformsGroups.js.map