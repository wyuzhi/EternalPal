<view class="container">
  <!-- ËÉåÊôØÂõæÁâáÂ±Ç -->
  <image src="/images/scenario/spring_sunny.jpg" mode="aspectFill" class="background-image"></image>
  
  <!-- È°∂ÈÉ®ÂØºËà™ -->
  <view class="header">
    <!-- ÁÇπÂáªÊâìÂºÄËÆ∞ÂøÜÈ°µÈù¢Ôºö/pages/memory/memoryÔºåÂåÖÂê´Èô™‰º¥Â§©Êï∞„ÄÅÊú¨ÊúàÊó•ÂéÜÔºàÊâìÂç°Ôºâ„ÄÅËÆ∞ÂøÜËÆ∞ÂΩï„ÄÅÁ∫™ÂøµÊó• -->
    <view class="header-icon" bindtap="onMemoryTap">
      <image src="/images/petProfile/date.svg" mode="aspectFit" class="memory-icon"></image>
    </view>
    
    <!-- ÂÆ†Áâ©‰ø°ÊÅØ -->
    <view class="pet-info-container">
      <view class="pet-info">
        <!-- ÂÆ†Áâ©Â§¥ÂÉè -->
        <view class="pet-avatar-container">
          <image src="{{petAvatar || '/images/logo.svg'}}" mode="aspectFit" class="pet-avatar"></image>
          
        </view>
        <!-- ÁªÜËäÇ -->
        <view class="pet-details">
          <text class="pet-name">{{petName || 'ÊàëÁöÑLinkiÁÅµ‰ªî'}}</text>
          <view class="mood-status">
            <text class="mood-emoji">{{moodEmoji || 'üòä'}}</text>
            <text class="mood-text">{{moodText || 'ÂºÄÂøÉ'}}</text>
          </view>
        </view>
      </view>
      <!-- ‰∫≤ÂØÜÂ∫¶ -->
      <view class="intimacy {{intimacyModuleClass}}" tt:if="{{showIntimacyModule}}">
        <view class="heart-container">
          <image src="/images/mainPage/heart.svg" mode="aspectFit" class="heart-icon"></image>
          <text class="intimacy-level">{{intimacyLevel}}</text>
        </view>
        <view class="progress-container">
          <view class="progress-bar">
            <view class="progress" style="width: {{intimacyProgress}}%;"></view>
          </view>
          <!-- ‰∫≤ÂØÜÂÄºÂ¢ûÂä†ÊèêÁ§∫ -->
          <view class="intimacy-increment {{intimacyIncrementClass}}" tt:if="{{showIntimacyIncrement}}">+{{intimacyIncrement}}</view>
        </view>
      </view>
    </view>
    <view class="header-icon">
      <image src="/images/mainPage/menu.svg" mode="aspectFit" class="menu-icon" bindtap="onSettingsTap"></image>
    </view>  
  </view>

  <!-- ËèúÂçïÈÅÆÁΩ©Â±Ç -->
  <view class="menu-mask" tt:if="{{showFloatMenu}}" bindtap="onMenuMaskTap"></view>
  
  <!-- ÊµÆÂä®ÂäüËÉΩËèúÂçï -->
  <view class="float-menu {{menuAnimationClass}}" tt:if="{{showFloatMenu}}">
    <button class="menu-item" bindtap="onMenuItemTap" data-action="info">
      <image src="/images/mainPage/list/animalFile.svg" class="menu-item-icon" mode="aspectFit"></image>
      <text>Ê°£Ê°à</text>
    </button>
    <button class="menu-item" bindtap="onMenuItemTap" data-action="settings">
      <image src="/images/mainPage/list/settings.svg" class="menu-item-icon" mode="aspectFit"></image>
      <text>ËÆæÁΩÆ</text>
    </button>
    <button class="menu-item" open-type="share" data-action="share">
      <image src="/images/mainPage/list/share.svg" class="menu-item-icon" mode="aspectFit"></image>
      <text>ÂàÜ‰∫´</text>
    </button>
  </view>

  

  <!-- ÂÆ†Áâ©Â±ïÁ§∫Âå∫ÔºàÂÆ†Áâ©Ê®°ÂºèÔºâ -->
  <view class="model-display" tt:if="{{!chatMode}}">
    <!-- ÂΩìÂâçÂØπËØùÊ∞îÊ≥° - ÊòæÁ§∫Âú®Ê®°Âûã‰∏äÊñπ -->
    <view class="current-chat-bubble {{bubbleAnimationClass}}" tt:if="{{currentMessage}}">
      <view class="bubble-content">
        <text>{{currentMessage}}</text>
      </view>
    </view>
    
    <view id="modelContainer" class="model-container {{modelStatus === 'Ëß¶Êë∏‰∏≠' ? 'touching' : ''}}">
        <!-- 3DÊ®°ÂûãÊòæÁ§∫Âå∫Âüü -->
        <canvas 
          type="2d" 
          id="modelCanvas" 
          class="model-canvas {{modelStatus === 'Ëß¶Êë∏‰∏≠' ? 'touching' : ''}}" 
          style="width: 100%; height: 100%;" 
          bindtouchstart="handleCanvasTouchStart"
          bindtouchmove="handleCanvasTouchMove"
          bindtouchend="handleCanvasTouchEnd"
          bindtap="handleCanvasDoubleTap"
          tt:if="{{!isImageMode}}">
        </canvas>
        <!-- Â¶ÇÊûú3DÊ®°ÂûãÂä†ËΩΩÂ§±Ë¥•ÔºåÂàôÊòæÁ§∫ÂõæÁâá -->
        <view tt:if="{{isImageMode}}" class="is-image-mode-container">
          <!-- Áõ¥Êé•ÊòæÁ§∫preview_urlÂõæÁâá -->
          <image src="{{preview_url}}" mode="aspectFit" class="pet-image"></image>
          <!-- Â¶ÇÊûúpreview_url‰∏∫Á©∫ÔºåÂàôÊòæÁ§∫Âç†‰ΩçÁ¨¶ -->
          <view tt:if="{{!preview_url}}" class="model-placeholder">
            <loader size="50px" color="#333" speed="0.8s"></loader>
          </view>
        </view>
        <!-- Âä†ËΩΩÊèêÁ§∫ -->
        <view tt:if="{{!modelLoaded}}" class="loading-overlay">
          <image tt:if="{{generatedPetImage}}" src="{{generatedPetImage}}" mode="aspectFit" class="loading-pet-image"></image>
          <text class="loading-simple-text">{{modelPlaceholderText || 'Â∞è‰∏ªËé´ÊÄ•ÔºåÊàëÁöÑ3dÂΩ¢Ë±°Ê≠£Âú®È£ûÈÄüËµ∂Êù•'}}</text>
        </view>
    </view>
  </view>

  <!-- Áî®Êà∑Ê∂àÊÅØÊòæÁ§∫Âå∫Âüü -->
  <view class="user-message-display {{userMessageAnimationClass}}" tt:if="{{userMessage}}">
    <view class="user-message-bubble">
      <text>{{userMessage}}</text>
    </view>
  </view>

  <!-- ËæìÂÖ•Âå∫Âüü -->
  <view class="chat-flow" style="bottom: {{keyboardHeight > 0 ? (keyboardHeight + 8) + 'px' : '0px'}}; padding-bottom: {{keyboardHeight > 0 ? '0rpx' : 'calc(' + safeAreaBottom + 'rpx + 24rpx)'}};">
    
    <!-- ËÅäÂ§©ÂéÜÂè≤Âå∫ÂüüÔºàËÅäÂ§©Ê®°ÂºèÔºâ -->
    <!-- <view class="chat-history-wrapper" wx:if="{{chatMode}}"> -->
      <view class="chat-history-display" wx:if="{{chatMode}}">
        <scroll-view class="chat-messages" scroll-y scroll-into-view="{{scrollToMessageId}}" scroll-with-animation>
          <!-- È°∂ÈÉ®Âç†‰ΩçÂÖÉÁ¥† -->
          <!-- <view class="message-spacer-top"></view> -->
          
          <block wx:for="{{messages}}" wx:key="id">
            <!-- Êó∂Èó¥ÂàÜÈöîÁ¨¶ -->
            <view class="time-separator" wx:if="{{item.isSeparator}}">
              <view class="time-separator-line"></view>
              <text class="time-separator-text">{{item.formattedTimestamp}}</text>
              <view class="time-separator-line"></view>
            </view>
            
            <!-- Ê∂àÊÅØÊ∞îÊ≥° -->
            <view id="message-{{item.validId}}" class="message-container {{item.isUser ? 'user-message' : 'ai-message'}}" wx:if="{{!item.isSeparator}}">
              <view class="message-bubble">
                <text>{{item.text}}</text>
              </view>
            </view>
          </block>
          
          <!-- Â∫ïÈÉ®Âç†‰ΩçÂÖÉÁ¥† -->
          <view class="message-spacer-bottom"></view>
        </scroll-view>
      </view>
    <!-- </view> -->
    
    <view class="send-container">
      <!-- Âø´Êç∑ËØùÊúØÂå∫Âüü -->
      <view class="quick-replies-container {{!showUIElements ? 'hide' : ''}}">
        <scroll-view class="quick-replies-scroll" scroll-x="true" show-scrollbar="false" enhanced="true" bounces="false">
          <view class="quick-replies">
            <button 
              tt:for="{{quickReplies}}" 
              tt:key="id" 
              class="quick-reply {{item.isTest ? 'test-button' : ''}}" 
              bindtap="useQuickReply" 
              data-text="{{item.text}}"
            >
              {{item.text}}
            </button>
            <!-- Âè≥ËæπË∑ùÂç†‰ΩçÂÖÉÁ¥† -->
            <view class="quick-reply-spacer"></view>
          </view>
        </scroll-view>
      </view>
      
      <!-- ÂäüËÉΩÂå∫ -->
      <view class="function-area {{!showUIElements ? 'hide' : ''}}">
        <!-- <view class="function-item {{isVideoActive ? 'active' : ''}}" bindtap="onVideoTap">
          <image src="/images/mainPage/video.svg" class="function-icon"></image>
        </view>
        <view class="function-item" bindtap="onMicTap">
          <image src="/images/mainPage/{{isMicOn ? 'mic' : 'micOff'}}.svg" class="function-icon"></image>
        </view>
        <view class="function-item" bindtap="onSpeakerTap">
          <image src="/images/mainPage/{{isSpeakerOn ? 'speaker' : 'speakerOff'}}.svg" class="function-icon"></image>
        </view> -->
        <view class="function-item {{isArActive ? 'active' : ''}}" bindtap="onArTap">
          <image src="/images/mainPage/ar.svg" class="function-icon"></image>
        </view>
        <view class="function-item {{modelRotationEnabled ? 'active' : ''}}" bindtap="toggleModelRotation" tt:if="{{!isImageMode}}">
          <image src="/images/mainPage/{{modelRotationEnabled ? 'rotate' : 'rotateOff'}}.svg" class="function-icon"></image>
        </view>
        <view class="function-item" bindtap="onTextChatTap">
          <image src="/images/mainPage/{{isTextChatActive ? 'petChat' : 'textChat'}}.svg" class="function-icon"></image>
        </view>
      </view>
      
      <!-- ËæìÂÖ•Âç°ÁâáÂå∫Âüü -->
      <view class="input-card">
        <view class="input-container">
          <textarea 
            placeholder="Ë∑ütaËØ¥‰∫õ‰ªÄ‰πàÂë¢..." 
            value="{{inputValue}}" 
            bindinput="onInput" 
            bindfocus="onInputFocus"
            bindblur="onInputBlur"
            class="chat-input" 
            maxlength="1000" 
            auto-height 
            adjust-position="{{false}}"></textarea>
          <view class="send-button" bindtap="sendMessage">
            <image src="/images/mainPage/send.svg" class="send-icon"></image>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>