<view class="system-pet-container">

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" tt:if="{{loading}}">
    <loader size="60px" color="#333" speed="0.8s"></loader>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-container" tt:if="{{!loading}}">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <image class="search-icon" src="/images/guide/search.svg" mode="aspectFit"></image>
        <input 
          class="search-input" 
          type="text" 
          placeholder="æœç´¢ç†æƒ³å‹çš„åç§°ã€å“ç§æˆ–æ€§æ ¼..." 
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindfocus="onSearchFocus"
          bindblur="onSearchBlur"
          confirm-type="search"
          bindconfirm="onSearchConfirm"
        />
        <view class="search-clear" tt:if="{{searchKeyword}}" bindtap="clearSearch">
          <view class="clear-icon">
            <image src="/images/guide/close.svg" mode="aspectFit"></image>
          </view>
        </view>
      </view>
    </view>
    
    <!-- æœç´¢å»ºè®® -->
    <view class="search-suggestions" tt:if="{{showSuggestions && searchSuggestions.length > 0}}">
      <view 
        class="suggestion-item" 
        tt:for="{{searchSuggestions}}" 
        tt:key="index"
        data-keyword="{{item}}"
        bindtap="selectSuggestion"
      >
        <image class="suggestion-icon" src="/images/guide/library.svg" mode="aspectFit"></image>
        <text class="suggestion-text">{{item}}</text>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é€‰æ‹©å™¨ -->
  <view class="tab-selector" tt:if="{{!loading}}">
    <scroll-view class="tab-scroll" scroll-x="true" show-scrollbar="false">
      <view class="tab-list">
        <view 
          class="tab-item {{currentTab === item.key ? 'active' : ''}}"
          tt:for="{{tabs}}"
          tt:key="key"
          data-tab="{{item.key}}"
          bindtap="onTabChange"
        >
          <text class="tab-text">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å® ç‰©åˆ—è¡¨ -->
  <view class="pets-container" tt:if="{{!loading}}">
    <view class="pets-waterfall">
      <view class="waterfall-column">
        <view 
          class="pet-card" 
          tt:for="{{leftColumnPets}}" 
          tt:key="id"
          data-pet-id="{{item.id}}"
          bindtap="onPetCardTap"
        >
          <!-- å® ç‰©é¢„è§ˆå›¾ -->
          <view class="pet-image-container">
            <image 
              class="pet-image" 
              src="{{item.2d_url || '/images/logo.svg'}}" 
              mode="aspectFill"
              lazy-load="true"
            />
            <!-- å® ç‰©ä¿¡æ¯è¦†ç›–å±‚ -->
            <view class="pet-info-overlay">
              <view class="pet-name-row">
                <view class="pet-name">{{item.name || 'Linki'}}</view>
                <view class="popularity-info">
                  <image class="popularity-icon" src="/images/guide/popular.svg" mode="aspectFit"></image>
                  <text class="popularity-count">{{item.popularity || 0}}</text>
                </view>
              </view>
              <view class="pet-details">
                <view class="detail-item" tt:if="{{item.type}}">
                  <text class="detail-label">ç§ç±»ï¼š</text>
                  <text class="detail-value">{{item.type}}</text>
                </view>
                <view class="detail-item" tt:if="{{item.personality}}">
                  <text class="detail-label">æ€§æ ¼ï¼š</text>
                  <text class="detail-value">{{item.personality}}</text>
                </view>
                <view class="detail-item" tt:if="{{item.hobbies}}">
                  <text class="detail-label">çˆ±å¥½ï¼š</text>
                  <text class="detail-value">{{item.hobbies}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="waterfall-column">
        <view 
          class="pet-card" 
          tt:for="{{rightColumnPets}}" 
          tt:key="id"
          data-pet-id="{{item.id}}"
          bindtap="onPetCardTap"
        >
          <!-- å® ç‰©é¢„è§ˆå›¾ -->
          <view class="pet-image-container">
            <image 
              class="pet-image" 
              src="{{item.2d_url || '/images/logo.svg'}}" 
              mode="aspectFill"
              lazy-load="true"
            />
            <!-- å® ç‰©ä¿¡æ¯è¦†ç›–å±‚ -->
            <view class="pet-info-overlay">
              <view class="pet-name-row">
                <view class="pet-name">{{item.name || 'ç¥ç§˜å˜‰å®¾'}}</view>
                <view class="popularity-info">
                  <image class="popularity-icon" src="/images/guide/popular.svg" mode="aspectFit"></image>
                  <text class="popularity-count">{{item.popularity || 0}}</text>
                </view>
              </view>
              <view class="pet-details">
                <view class="detail-item" tt:if="{{item.type}}">
                  <text class="detail-label">ç§ç±»ï¼š</text>
                  <text class="detail-value">{{item.type}}</text>
                </view>
                <view class="detail-item" tt:if="{{item.personality}}">
                  <text class="detail-label">æ€§æ ¼ï¼š</text>
                  <text class="detail-value">{{item.personality}}</text>
                </view>
                <view class="detail-item" tt:if="{{item.hobbies}}">
                  <text class="detail-label">çˆ±å¥½ï¼š</text>
                  <text class="detail-value">{{item.hobbies}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" tt:if="{{systemPets.length === 0}}">
      <view class="empty-icon">ğŸ¾</view>
      <view class="empty-text">æš‚æ— å¯é¢†å…»çš„Linki</view>
      <view class="empty-desc">è¯·ç¨åå†æ¥çœ‹çœ‹å§</view>
    </view>
  </view>

  <!-- é¢†å…»ç¡®è®¤å¼¹çª— -->
  <popup show="{{showAdoptModal}}" position="center" bind:close="closeAdoptModal">
    <view class="adopt-modal-content">
      <!-- <view class="adopt-modal-header">
        <text class="adopt-modal-title">ç¡®è®¤é¢†å…»</text>
      </view> -->
      
      <view class="adopt-modal-body">
        <view class="adopt-pet-info">
          <image 
            class="adopt-pet-image" 
            src="{{selectedPet.preview_url || '/static/images/default-pet.png'}}" 
            mode="aspectFill"
          />
          <view class="adopt-pet-details">
            <view class="adopt-pet-name">{{selectedPet.name || 'ç¥ç§˜å® ç‰©'}}</view>
            <view class="adopt-pet-traits">
              <text tt:if="{{selectedPet.personality}}">æ€§æ ¼ï¼š{{selectedPet.personality}}</text>
              <text tt:if="{{selectedPet.hobbies}}">çˆ±å¥½ï¼š{{selectedPet.hobbies}}</text>
            </view>
          </view>
        </view>
        
        <view class="adopt-message">
          <text class="message-text">ä½ ç¡®å®šè¦é¢†å…»æˆ‘å—ï¼ŸæœŸå¾…ingï¼</text>
          <text class="message-desc">é¢†å…»åæˆ‘ä¼šæˆä¸ºä½ çš„ä¸“å±ä¼™ä¼´å“¦ï¼</text>
        </view>
      </view>
      
      <view class="adopt-modal-footer">
        <view class="adopt-modal-btn cancel-btn" bindtap="closeAdoptModal">
          <text class="btn-text">å–æ¶ˆ</text>
        </view>
        <view class="adopt-modal-btn confirm-btn" bindtap="confirmAdopt">
          <text class="btn-text">ç¡®è®¤é¢†å…»</text>
        </view>
      </view>
    </view>
  </popup>

  <!-- éšæœºæŒ‰é’® -->
  <view class="random-button" bindtap="onRandomSelect" tt:if="{{!loading && systemPets.length > 0}}">
    <image class="random-icon" src="/images/guide/dice.svg" mode="aspectFit"></image>
  </view>

  <!-- æŠ½å¡æ•ˆæœå¼¹çª— -->
  <view class="card-draw-overlay" tt:if="{{showCardDraw}}" bindtap="skipCardAnimation">
    <view class="card-draw-container">
      <!-- èƒŒæ™¯å…‰æ•ˆ -->
      <view class="card-draw-bg">
        <view class="light-beam light-beam-1"></view>
        <view class="light-beam light-beam-2"></view>
        <view class="light-beam light-beam-3"></view>
        <view class="sparkle sparkle-1"></view>
        <view class="sparkle sparkle-2"></view>
        <view class="sparkle sparkle-3"></view>
        <view class="sparkle sparkle-4"></view>
        <view class="sparkle sparkle-5"></view>
      </view>
      
      <!-- å¡ç‰Œå®¹å™¨ -->
      <view class="card-container">
        <!-- å¡ç‰ŒèƒŒé¢ -->
        <view class="card-back {{cardFlipped ? 'flipped' : ''}}" tt:if="{{!cardRevealed}}">
          <view class="card-back-pattern">
            <view class="pattern-circle"></view>
            <view class="pattern-star">âœ¨</view>
            <text class="card-back-text">Linki</text>
          </view>
        </view>
        
        <!-- å¡ç‰Œæ­£é¢ -->
        <view class="card-front {{cardRevealed ? 'revealed' : ''}}" tt:if="{{selectedPet}}">
          <view class="card-pet-image">
            <image 
              class="pet-card-image" 
              src="{{selectedPet.2d_url || '/images/logo.svg'}}" 
              mode="aspectFill"
            />
          </view>
          <view class="card-pet-info">
            <view class="card-pet-name">{{selectedPet.name || 'ç¥ç§˜å® ç‰©'}}</view>
            <view class="card-pet-type">{{selectedPet.type || 'æœªçŸ¥å“ç§'}}</view>
            <view class="card-pet-personality">{{selectedPet.personality || 'ç¥ç§˜æ€§æ ¼'}}</view>
          </view>
          <view class="card-rarity-glow"></view>
        </view>
      </view>
      
      <!-- æŠ½å¡æç¤ºæ–‡å­— -->
      <view class="card-draw-text">
        <text class="draw-title" tt:if="{{!cardRevealed}}">{{cardDrawText}}</text>
        <text class="draw-result" tt:if="{{cardRevealed}}">æˆ‘æ¥å•¦ï¼</text>
        <text class="draw-hint" tt:if="{{cardRevealed}}">ç‚¹å‡»ä»»æ„å¤„ç»§ç»­</text>
      </view>
    </view>
  </view>
</view>